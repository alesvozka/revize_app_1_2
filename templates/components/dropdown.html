<!-- 
VYLEPŠENÝ DROPDOWN WIDGET - Verze 2.0
Všechny možnosti integrované přímo v dropdownu bez externích tlačítek.

Možnosti:
1. Výběr z databáze
2. Přidání nového záznamu přímo v dropdownu
3. Volný textový vstup (přepínání tlačítkem)

Usage:
{{ render_field_improved(
    field_name='switchboard_device_type',
    field_label='Typ přístroje',
    current_value=device.switchboard_device_type if device else '',
    entity_type='device',
    dropdown_config=dropdown_config,
    dropdown_sources=dropdown_sources,
    placeholder='Např. RCD, MCB',
    help_text='Typ přístroje'
) }}
-->

{% macro render_field_improved(field_name, field_label, current_value='', entity_type='', dropdown_config={}, dropdown_sources={}, placeholder='', help_text='', required=False) %}

{% set config = dropdown_config.get(entity_type, {}).get(field_name, {}) %}
{% set mode = config.get('mode', 'db') %}
{% set category = config.get('category', '') %}

<div class="custom-dropdown-wrapper" data-field="{{ field_name }}">
    <label for="{{ field_name }}" class="form-label">
        {{ field_label }}
        {% if required %}<span class="text-red-500">*</span>{% endif %}
    </label>
    
    <div class="custom-dropdown">
        <!-- Hlavní input/select field -->
        <input type="text" 
               id="{{ field_name }}"
               name="{{ field_name }}"
               value="{{ current_value }}"
               placeholder="{{ placeholder }}"
               class="dropdown-input"
               autocomplete="off"
               onfocus="openDropdown('{{ field_name }}')"
               oninput="filterDropdown('{{ field_name }}', this.value)"
               {% if required %}required{% endif %}>
        
        <!-- Ikony pro přepínání módu -->
        <div class="dropdown-mode-toggle">
            <svg class="mode-icon mode-icon-dropdown active" 
                 data-mode="dropdown"
                 onclick="toggleDropdownMode('{{ field_name }}', 'dropdown')"
                 title="Vybrat z databáze"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
            <svg class="mode-icon mode-icon-text" 
                 data-mode="text"
                 onclick="toggleDropdownMode('{{ field_name }}', 'text')"
                 title="Volný text"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
        </div>
        
        <!-- Dropdown menu -->
        <div class="dropdown-menu" data-field="{{ field_name }}">
            <!-- Sekce pro přidání nové hodnoty -->
            <div class="dropdown-add-new">
                <input type="text" 
                       id="{{ field_name }}_new_value"
                       class="dropdown-add-input"
                       placeholder="Nová hodnota..."
                       onkeypress="if(event.key==='Enter'){event.preventDefault();addNewDropdownValueImproved('{{ field_name }}', '{{ category }}');}">
                <button type="button"
                        class="dropdown-add-btn"
                        onclick="addNewDropdownValueImproved('{{ field_name }}', '{{ category }}')">
                    + Přidat
                </button>
            </div>
            
            <!-- Seznam hodnot z databáze -->
            <div class="dropdown-items" data-field="{{ field_name }}">
                {% if category and dropdown_sources.get(category) %}
                    {% for source in dropdown_sources.get(category, []) %}
                    <div class="dropdown-item" 
                         data-value="{{ source.value }}"
                         onclick="selectDropdownValue('{{ field_name }}', '{{ source.value }}')">
                        {{ source.value }}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="dropdown-item" style="color: #9ca3af; cursor: default;">
                        Žádné hodnoty v databázi
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    {% if help_text %}
    <p class="form-help">{{ help_text }}</p>
    {% endif %}
</div>

{% endmacro %}

<script>
// Globální stav dropdownů
const dropdownStates = {};

// Inicializace dropdownu
function initDropdown(fieldName) {
    if (!dropdownStates[fieldName]) {
        dropdownStates[fieldName] = {
            mode: 'dropdown', // 'dropdown' nebo 'text'
            isOpen: false
        };
    }
}

// Otevření dropdownu
function openDropdown(fieldName) {
    initDropdown(fieldName);
    
    // Pokud je v textovém módu, neotevírej dropdown
    if (dropdownStates[fieldName].mode === 'text') {
        return;
    }
    
    const menu = document.querySelector(`.dropdown-menu[data-field="${fieldName}"]`);
    if (menu) {
        menu.classList.add('active');
        dropdownStates[fieldName].isOpen = true;
    }
}

// Zavření dropdownu
function closeDropdown(fieldName) {
    const menu = document.querySelector(`.dropdown-menu[data-field="${fieldName}"]`);
    if (menu) {
        menu.classList.remove('active');
        dropdownStates[fieldName].isOpen = false;
    }
}

// Přepnutí mezi dropdown a text módem
function toggleDropdownMode(fieldName, mode) {
    initDropdown(fieldName);
    
    const wrapper = document.querySelector(`.custom-dropdown-wrapper[data-field="${fieldName}"]`);
    const dropdownIcon = wrapper.querySelector('.mode-icon-dropdown');
    const textIcon = wrapper.querySelector('.mode-icon-text');
    const input = wrapper.querySelector(`#${fieldName}`);
    
    dropdownStates[fieldName].mode = mode;
    
    if (mode === 'dropdown') {
        dropdownIcon.classList.add('active');
        textIcon.classList.remove('active');
        input.setAttribute('readonly', false);
        input.focus();
        openDropdown(fieldName);
    } else {
        dropdownIcon.classList.remove('active');
        textIcon.classList.add('active');
        closeDropdown(fieldName);
        input.removeAttribute('readonly');
        input.focus();
    }
}

// Výběr hodnoty z dropdownu
function selectDropdownValue(fieldName, value) {
    const input = document.querySelector(`#${fieldName}`);
    if (input) {
        input.value = value;
        closeDropdown(fieldName);
    }
}

// Filtrování hodnot v dropdownu
function filterDropdown(fieldName, searchTerm) {
    initDropdown(fieldName);
    
    // Pokud je v textovém módu, nefiltruj
    if (dropdownStates[fieldName].mode === 'text') {
        return;
    }
    
    const itemsContainer = document.querySelector(`.dropdown-items[data-field="${fieldName}"]`);
    if (!itemsContainer) return;
    
    const items = itemsContainer.querySelectorAll('.dropdown-item');
    const searchLower = searchTerm.toLowerCase();
    
    let visibleCount = 0;
    items.forEach(item => {
        const value = item.getAttribute('data-value');
        if (value && value.toLowerCase().includes(searchLower)) {
            item.style.display = 'block';
            visibleCount++;
        } else if (value) {
            item.style.display = 'none';
        }
    });
    
    // Otevři dropdown pokud je něco napsáno
    if (searchTerm.length > 0 && visibleCount > 0) {
        openDropdown(fieldName);
    }
}

// Přidání nové hodnoty do databáze
async function addNewDropdownValueImproved(fieldName, category) {
    const newValueInput = document.querySelector(`#${fieldName}_new_value`);
    const value = newValueInput.value.trim();
    
    if (!value) {
        alert('Zadejte hodnotu');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('value', value);
        
        const response = await fetch(`/api/dropdown/${category}/add`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Přidej novou položku do seznamu
            const itemsContainer = document.querySelector(`.dropdown-items[data-field="${fieldName}"]`);
            
            // Odstraň "Žádné hodnoty" pokud existuje
            const emptyMsg = itemsContainer.querySelector('[style*="cursor: default"]');
            if (emptyMsg) {
                emptyMsg.remove();
            }
            
            // Vytvoř novou položku
            const newItem = document.createElement('div');
            newItem.className = 'dropdown-item';
            newItem.setAttribute('data-value', data.value);
            newItem.textContent = data.value;
            newItem.onclick = function() { selectDropdownValue(fieldName, data.value); };
            
            // Přidej na začátek seznamu
            itemsContainer.insertBefore(newItem, itemsContainer.firstChild);
            
            // Vyber novou hodnotu
            selectDropdownValue(fieldName, data.value);
            
            // Vyčisti input
            newValueInput.value = '';
        } else {
            alert('Chyba: ' + (data.error || 'Neznámá chyba'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Chyba při přidávání hodnoty');
    }
}

// Zavření dropdownu při kliknutí mimo
document.addEventListener('click', function(event) {
    const dropdowns = document.querySelectorAll('.custom-dropdown');
    
    dropdowns.forEach(dropdown => {
        if (!dropdown.contains(event.target)) {
            const wrapper = dropdown.closest('.custom-dropdown-wrapper');
            if (wrapper) {
                const fieldName = wrapper.getAttribute('data-field');
                closeDropdown(fieldName);
            }
        }
    });
});

// Inicializace všech dropdownů při načtení stránky
document.addEventListener('DOMContentLoaded', function() {
    const dropdowns = document.querySelectorAll('.custom-dropdown-wrapper');
    dropdowns.forEach(wrapper => {
        const fieldName = wrapper.getAttribute('data-field');
        initDropdown(fieldName);
    });
});
</script>
{% endmacro %}
