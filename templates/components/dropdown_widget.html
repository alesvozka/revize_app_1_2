<!-- 
Universal Dropdown Widget with 3 modes:
1. Select from database
2. Add new value inline
3. Free text input

Usage:
{% include 'components/dropdown_widget.html' with context %}

Parameters:
- field_name: Name of the form field (required)
- field_label: Label for the field (required)
- category: Dropdown category from dropdown_sources (required for modes 1&2)
- current_value: Current value to pre-select (optional)
- placeholder: Placeholder text (optional)
- field_help: Help text below field (optional)
-->

<div class="dropdown-widget-container" data-field="{{ field_name }}">
    <label for="{{ field_name }}" class="block text-sm font-medium text-gray-700 mb-2">
        {{ field_label }}
    </label>
    
    <!-- Mode Selector Buttons -->
    <div class="flex gap-2 mb-2">
        <button type="button" 
                onclick="switchDropdownMode('{{ field_name }}', 'select')"
                class="mode-btn mode-btn-select px-3 py-1.5 text-xs font-medium border rounded transition-colors"
                data-field="{{ field_name }}">
            üìã Z datab√°ze
        </button>
        <button type="button" 
                onclick="switchDropdownMode('{{ field_name }}', 'add')"
                class="mode-btn mode-btn-add px-3 py-1.5 text-xs font-medium border rounded transition-colors"
                data-field="{{ field_name }}">
            ‚ûï P≈ôidat nov√Ω
        </button>
        <button type="button" 
                onclick="switchDropdownMode('{{ field_name }}', 'text')"
                class="mode-btn mode-btn-text px-3 py-1.5 text-xs font-medium border rounded transition-colors"
                data-field="{{ field_name }}">
            ‚úé Voln√Ω text
        </button>
    </div>

    <!-- Mode 1: Select from database (CUSTOM DROPDOWN) -->
    <div class="mode-content mode-select" data-field="{{ field_name }}">
        <div class="custom-select-wrapper relative">
            <input type="hidden" 
                   id="{{ field_name }}" 
                   name="{{ field_name }}"
                   value="{{ current_value or '' }}">
            
            <button type="button" 
                    class="custom-select-trigger w-full px-3 py-2 border border-gray-300 rounded text-left bg-white hover:border-gray-400 transition-colors flex items-center justify-between"
                    onclick="toggleCustomSelect('{{ field_name }}')">
                <span class="custom-select-value text-gray-900">
                    {% if current_value %}
                        {{ current_value }}
                    {% else %}
                        -- Vyberte hodnotu --
                    {% endif %}
                </span>
                <svg class="w-4 h-4 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            
            <div class="custom-select-options absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded shadow-lg max-h-60 overflow-y-auto hidden">
                <div class="custom-select-option px-3 py-2 hover:bg-gray-100 cursor-pointer text-gray-500"
                     data-value="">
                    -- Vyberte hodnotu --
                </div>
                {% if category %}
                    {% for source in dropdown_sources.get(category, []) %}
                    <div class="custom-select-option px-3 py-2 hover:bg-blue-50 cursor-pointer text-gray-900 {% if current_value == source.value %}bg-blue-50 font-medium{% endif %}"
                         data-value="{{ source.value }}">
                        {{ source.value }}
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Mode 2: Add new value -->
    <div class="mode-content mode-add hidden" data-field="{{ field_name }}">
        <div class="flex gap-2">
            <input type="text" 
                   id="{{ field_name }}_new"
                   placeholder="Zadejte novou hodnotu..."
                   class="flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-green-500 focus:border-transparent">
            <button type="button"
                    onclick="addNewDropdownValue('{{ field_name }}', '{{ category }}')"
                    class="px-4 py-2 bg-green-600 text-white font-medium rounded hover:bg-green-700 transition">
                P≈ôidat a vybrat
            </button>
        </div>
        <p class="text-xs text-gray-500 mt-1">Hodnota bude ulo≈æena do datab√°ze a bude k dispozici i pro dal≈°√≠ pou≈æit√≠</p>
    </div>

    <!-- Mode 3: Free text -->
    <div class="mode-content mode-text hidden" data-field="{{ field_name }}">
        <input type="text" 
               id="{{ field_name }}_text"
               name="{{ field_name }}"
               value="{{ current_value or '' }}"
               placeholder="{{ placeholder or 'Zadejte hodnotu...' }}"
               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <p class="text-xs text-gray-500 mt-1">Hodnota se ulo≈æ√≠ pouze do tohoto z√°znamu, nebude p≈ôid√°na do datab√°ze hodnot</p>
    </div>

    {% if field_help %}
    <p class="mt-1 text-xs text-gray-500">{{ field_help }}</p>
    {% endif %}
</div>

<script>
// Toggle custom select dropdown
function toggleCustomSelect(fieldName) {
    const container = document.querySelector(`.dropdown-widget-container[data-field="${fieldName}"]`);
    const wrapper = container.querySelector('.custom-select-wrapper');
    const options = wrapper.querySelector('.custom-select-options');
    const arrow = wrapper.querySelector('svg');
    
    // Close all other dropdowns first
    document.querySelectorAll('.custom-select-options').forEach(opt => {
        if (opt !== options) {
            opt.classList.add('hidden');
        }
    });
    document.querySelectorAll('.custom-select-wrapper svg').forEach(svg => {
        if (svg !== arrow) {
            svg.classList.remove('rotate-180');
        }
    });
    
    // Toggle this dropdown
    options.classList.toggle('hidden');
    arrow.classList.toggle('rotate-180');
}

// Handle option selection in custom dropdown
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('custom-select-option')) {
        const option = e.target;
        const value = option.getAttribute('data-value');
        const wrapper = option.closest('.custom-select-wrapper');
        const container = option.closest('.dropdown-widget-container');
        const fieldName = container.getAttribute('data-field');
        
        // Update hidden input
        const hiddenInput = wrapper.querySelector(`input[type="hidden"]`);
        hiddenInput.value = value;
        
        // Update display text
        const displayText = wrapper.querySelector('.custom-select-value');
        displayText.textContent = value || '-- Vyberte hodnotu --';
        displayText.classList.toggle('text-gray-500', !value);
        displayText.classList.toggle('text-gray-900', !!value);
        
        // Update option styling
        wrapper.querySelectorAll('.custom-select-option').forEach(opt => {
            opt.classList.remove('bg-blue-50', 'font-medium');
        });
        option.classList.add('bg-blue-50', 'font-medium');
        
        // Close dropdown
        wrapper.querySelector('.custom-select-options').classList.add('hidden');
        wrapper.querySelector('svg').classList.remove('rotate-180');
    }
});

// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.custom-select-wrapper') && !e.target.classList.contains('custom-select-option')) {
        document.querySelectorAll('.custom-select-options').forEach(opt => {
            opt.classList.add('hidden');
        });
        document.querySelectorAll('.custom-select-wrapper svg').forEach(svg => {
            svg.classList.remove('rotate-180');
        });
    }
});

// Switch between dropdown modes
function switchDropdownMode(fieldName, mode) {
    const container = document.querySelector(`.dropdown-widget-container[data-field="${fieldName}"]`);
    
    // Hide all mode contents
    container.querySelectorAll('.mode-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Remove active state from all buttons
    container.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
        btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
    });
    
    // Show selected mode content
    const selectedContent = container.querySelector(`.mode-${mode}[data-field="${fieldName}"]`);
    selectedContent.classList.remove('hidden');
    
    // Add active state to selected button
    const selectedBtn = container.querySelector(`.mode-btn-${mode}[data-field="${fieldName}"]`);
    selectedBtn.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
    selectedBtn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
    
    // Disable/enable form fields based on mode
    const hiddenField = container.querySelector(`input[type="hidden"]#${fieldName}`);
    const textField = container.querySelector(`input#${fieldName}_text`);
    
    if (mode === 'select') {
        if (hiddenField) hiddenField.disabled = false;
        if (textField) textField.disabled = true;
    } else if (mode === 'text') {
        if (hiddenField) hiddenField.disabled = true;
        if (textField) textField.disabled = false;
    } else {
        if (hiddenField) hiddenField.disabled = true;
        if (textField) textField.disabled = true;
    }
}

// Add new value to dropdown and select it
async function addNewDropdownValue(fieldName, category) {
    const container = document.querySelector(`.dropdown-widget-container[data-field="${fieldName}"]`);
    const newValueInput = container.querySelector(`#${fieldName}_new`);
    const value = newValueInput.value.trim();
    
    if (!value) {
        alert('Zadejte hodnotu');
        return;
    }
    
    try {
        // Send request to add new value
        const formData = new FormData();
        formData.append('value', value);
        
        const response = await fetch(`/api/dropdown/${category}/add`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Add new option to custom select
            const optionsContainer = container.querySelector('.custom-select-options');
            const newOption = document.createElement('div');
            newOption.className = 'custom-select-option px-3 py-2 hover:bg-blue-50 cursor-pointer text-gray-900 bg-blue-50 font-medium';
            newOption.setAttribute('data-value', data.value);
            newOption.textContent = data.value;
            optionsContainer.appendChild(newOption);
            
            // Update hidden input and display
            const hiddenInput = container.querySelector(`input[type="hidden"]#${fieldName}`);
            hiddenInput.value = data.value;
            const displayText = container.querySelector('.custom-select-value');
            displayText.textContent = data.value;
            displayText.classList.remove('text-gray-500');
            displayText.classList.add('text-gray-900');
            
            // Switch back to select mode
            switchDropdownMode(fieldName, 'select');
            
            // Clear input
            newValueInput.value = '';
            
            // Show success message
            alert(`Hodnota "${data.value}" byla p≈ôid√°na a vybr√°na`);
        } else {
            alert('Chyba p≈ôi p≈ôid√°v√°n√≠ hodnoty: ' + (data.error || 'Nezn√°m√° chyba'));
        }
    } catch (error) {
        console.error('Error adding dropdown value:', error);
        alert('Chyba p≈ôi p≈ôid√°v√°n√≠ hodnoty');
    }
}

// Initialize first mode on page load
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.dropdown-widget-container').forEach(container => {
        const fieldName = container.getAttribute('data-field');
        // Start with select mode by default
        switchDropdownMode(fieldName, 'select');
    });
});
</script>

<style>
.dropdown-widget-container {
    position: relative;
}

.mode-btn {
    cursor: pointer;
}

.mode-btn:hover {
    opacity: 0.9;
}

.custom-select-wrapper {
    position: relative;
}

.custom-select-trigger {
    cursor: pointer;
}

.custom-select-trigger:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
}

.custom-select-options {
    max-height: 240px;
}

.custom-select-option:first-child {
    color: #9ca3af;
}

/* Smooth arrow rotation */
.custom-select-wrapper svg {
    transition: transform 0.2s ease;
}

.rotate-180 {
    transform: rotate(180deg);
}
</style>
