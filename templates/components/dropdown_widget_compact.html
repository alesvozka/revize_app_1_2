<!-- 
Compact Dropdown Widget with integrated functionality:
- Type directly for one-time value (not saved to dropdown database)
- Click arrow to open dropdown with database values
- Last option in dropdown: "Add new value" opens modal
- Modal saves to database and auto-selects new value



Parameters:
- field_name: Name of the form field (required)
- field_label: Label for the field (required)
- category: Dropdown category from dropdown_sources (required)
- current_value: Current value to pre-select (optional)
- placeholder: Placeholder text (optional)
- field_help: Help text below field (optional)
-->

<div class="dropdown-widget-container" data-field="{{ field_name }}" data-category="{{ category }}">
    <label for="{{ field_name }}" class="block text-sm font-medium text-gray-700 mb-2">
        {{ field_label }}
    </label>
    
    <!-- Combo Box: Input + Dropdown -->
    <div class="relative">
        <!-- Input field (editable, for direct typing) -->
        <input type="text" 
               id="{{ field_name }}" 
               name="{{ field_name }}"
               value="{{ current_value | string | default('', true) }}"
               placeholder="{{ placeholder or 'Vyberte nebo zadejte hodnotu...' }}"
               autocomplete="off"
               class="w-full px-3 py-2 pr-10 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        
        <!-- Dropdown toggle button -->
        <button type="button" 
                onclick="toggleDropdown('{{ field_name }}')"
                class="absolute right-0 top-0 h-full px-3 text-gray-500 hover:text-gray-700 border-l border-gray-300 bg-gray-50 hover:bg-gray-100 transition-colors rounded-r">
            <svg class="w-4 h-4 transition-transform dropdown-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </button>
        
        <!-- Dropdown options -->
        <div class="dropdown-options absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded shadow-lg max-h-60 overflow-y-auto hidden">
            {% if category and category != '' and dropdown_sources.get(category) %}
                {% for source in dropdown_sources.get(category, []) %}
                <div class="dropdown-option px-3 py-2 hover:bg-blue-50 cursor-pointer text-gray-900 {% if current_value == source.value %}bg-blue-50 font-medium{% endif %}"
                     onclick="selectDropdownValue('{{ field_name }}', {{ source.value | tojson }})">
                    {{ source.value }}
                </div>
                {% endfor %}
                
                <!-- Separator -->
                <div class="border-t border-gray-200 my-1"></div>
            {% endif %}
            
            <!-- Add new value option -->
            <div class="dropdown-option px-3 py-2 hover:bg-green-50 cursor-pointer text-green-700 font-medium flex items-center gap-2"
                 onclick="openAddValueModal('{{ field_name }}', '{{ category }}')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                P콏idat novou hodnotu...
            </div>
        </div>
    </div>

    {% if field_help %}
    <p class="mt-1 text-xs text-gray-500">{{ field_help }}</p>
    {% endif %}
    
    <p class="mt-1 text-xs text-gray-500">
        游눠 <strong>Tip:</strong> Pi코te p콏칤mo pro jednor치zovou hodnotu, nebo klikn캩te na 코ipku pro v칳b캩r z datab치ze
    </p>
</div>

<!-- Modal for adding new value (shared by all dropdowns) -->
<div id="add-value-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center" onclick="closeAddValueModal(event)">
    <div class="modal-content bg-white rounded-lg shadow-xl max-w-md w-full mx-4" onclick="event.stopPropagation()">
        <div class="modal-header px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">P콏idat novou hodnotu</h3>
            <button onclick="closeAddValueModal()" class="text-gray-400 hover:text-gray-600 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <div class="modal-body px-6 py-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Nov치 hodnota
            </label>
            <input type="text" 
                   id="modal-new-value"
                   placeholder="Zadejte hodnotu..."
                   class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-green-500 focus:border-transparent">
            <p class="text-xs text-gray-500 mt-2">
                Hodnota bude ulo쬰na do datab치ze a automaticky vybr치na
            </p>
        </div>
        
        <div class="modal-footer px-6 py-4 border-t border-gray-200 flex justify-end gap-3">
            <button onclick="closeAddValueModal()" 
                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition">
                Zru코it
            </button>
            <button onclick="saveNewValue()" 
                    class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition font-medium">
                P콏idat a vybrat
            </button>
        </div>
    </div>
</div>

<script>
// State for modal
let currentModalField = null;
let currentModalCategory = null;

// Toggle dropdown
function toggleDropdown(fieldName) {
    const container = document.querySelector(`.dropdown-widget-container[data-field="${fieldName}"]`);
    const dropdown = container.querySelector('.dropdown-options');
    const arrow = container.querySelector('.dropdown-arrow');
    
    // Close all other dropdowns
    document.querySelectorAll('.dropdown-options').forEach(d => {
        if (d !== dropdown) d.classList.add('hidden');
    });
    document.querySelectorAll('.dropdown-arrow').forEach(a => {
        if (a !== arrow) a.classList.remove('rotate-180');
    });
    
    // Toggle this dropdown
    dropdown.classList.toggle('hidden');
    arrow.classList.toggle('rotate-180');
}

// Select value from dropdown
function selectDropdownValue(fieldName, value) {
    const container = document.querySelector(`.dropdown-widget-container[data-field="${fieldName}"]`);
    const input = container.querySelector(`#${fieldName}`);
    const dropdown = container.querySelector('.dropdown-options');
    const arrow = container.querySelector('.dropdown-arrow');
    
    // Set value
    input.value = value;
    
    // Update option styling
    container.querySelectorAll('.dropdown-option').forEach(opt => {
        opt.classList.remove('bg-blue-50', 'font-medium');
    });
    
    // Close dropdown
    dropdown.classList.add('hidden');
    arrow.classList.remove('rotate-180');
    
    // Focus input (optional, for better UX)
    input.focus();
}

// Open modal for adding new value
function openAddValueModal(fieldName, category) {
    currentModalField = fieldName;
    currentModalCategory = category;
    
    // Close dropdown first
    const container = document.querySelector(`.dropdown-widget-container[data-field="${fieldName}"]`);
    const dropdown = container.querySelector('.dropdown-options');
    const arrow = container.querySelector('.dropdown-arrow');
    dropdown.classList.add('hidden');
    arrow.classList.remove('rotate-180');
    
    // Show modal
    const modal = document.getElementById('add-value-modal');
    const input = document.getElementById('modal-new-value');
    modal.classList.remove('hidden');
    input.value = '';
    input.focus();
}

// Close modal
function closeAddValueModal(event) {
    // If event is provided and target is not the overlay, don't close
    if (event && event.target !== event.currentTarget) {
        return;
    }
    
    const modal = document.getElementById('add-value-modal');
    modal.classList.add('hidden');
    currentModalField = null;
    currentModalCategory = null;
}

// Save new value from modal
async function saveNewValue() {
    const input = document.getElementById('modal-new-value');
    const value = input.value.trim();
    
    if (!value) {
        alert('Zadejte hodnotu');
        input.focus();
        return;
    }
    
    if (!currentModalField || !currentModalCategory) {
        alert('Chyba: Nezn치m칠 pole nebo kategorie');
        return;
    }
    
    try {
        // Send request to add new value
        const formData = new FormData();
        formData.append('value', value);
        
        const response = await fetch(`/api/dropdown/${currentModalCategory}/add`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Find the container and dropdown
            const container = document.querySelector(`.dropdown-widget-container[data-field="${currentModalField}"]`);
            const dropdown = container.querySelector('.dropdown-options');
            const fieldInput = container.querySelector(`#${currentModalField}`);
            
            // Add new option to dropdown (before the separator)
            const separator = dropdown.querySelector('.border-t');
            const newOption = document.createElement('div');
            newOption.className = 'dropdown-option px-3 py-2 hover:bg-blue-50 cursor-pointer text-gray-900';
            newOption.setAttribute('onclick', `selectDropdownValue('${currentModalField}', '${data.value}')`);
            newOption.textContent = data.value;
            
            if (separator) {
                dropdown.insertBefore(newOption, separator);
            } else {
                dropdown.insertBefore(newOption, dropdown.lastElementChild);
            }
            
            // Set the new value in the input
            fieldInput.value = data.value;
            
            // Close modal
            closeAddValueModal();
            
            // Show success message
            alert(`Hodnota "${data.value}" byla p콏id치na a vybr치na`);
        } else {
            alert('Chyba p콏i p콏id치v치n칤 hodnoty: ' + (data.error || 'Nezn치m치 chyba'));
        }
    } catch (error) {
        console.error('Error adding dropdown value:', error);
        alert('Chyba p콏i p콏id치v치n칤 hodnoty');
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.dropdown-widget-container') && !e.target.closest('.modal-overlay')) {
        document.querySelectorAll('.dropdown-options').forEach(d => {
            d.classList.add('hidden');
        });
        document.querySelectorAll('.dropdown-arrow').forEach(a => {
            a.classList.remove('rotate-180');
        });
    }
});

// Handle Enter key in modal
document.addEventListener('DOMContentLoaded', function() {
    const modalInput = document.getElementById('modal-new-value');
    if (modalInput) {
        modalInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveNewValue();
            }
        });
    }
});

// Handle Escape key to close modal
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('add-value-modal');
        if (!modal.classList.contains('hidden')) {
            closeAddValueModal();
        }
    }
});
</script>

<style>
.dropdown-widget-container {
    position: relative;
}

.dropdown-arrow {
    transition: transform 0.2s ease;
}

.rotate-180 {
    transform: rotate(180deg);
}

.dropdown-option {
    transition: background-color 0.15s ease;
}

.modal-overlay {
    animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

.modal-content {
    animation: slideUp 0.2s ease;
}

@keyframes slideUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}
</style>
