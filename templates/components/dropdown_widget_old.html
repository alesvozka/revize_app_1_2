<!-- 
Universal Dropdown Widget with 3 modes:
1. Select from database
2. Add new value inline
3. Free text input

Usage:
{% include 'components/dropdown_widget.html' with context %}

Parameters:
- field_name: Name of the form field (required)
- field_label: Label for the field (required)
- category: Dropdown category from dropdown_sources (required for modes 1&2)
- current_value: Current value to pre-select (optional)
- placeholder: Placeholder text (optional)
- field_help: Help text below field (optional)
-->

<div class="dropdown-widget-container" data-field="{{ field_name }}">
    <label for="{{ field_name }}" class="block text-sm font-medium text-gray-700 mb-2">
        {{ field_label }}
    </label>
    
    <!-- Mode Selector Buttons -->
    <div class="flex gap-2 mb-2">
        <button type="button" 
                onclick="switchDropdownMode('{{ field_name }}', 'select')"
                class="mode-btn mode-btn-select px-3 py-1 text-xs font-medium border rounded transition-colors"
                data-field="{{ field_name }}">
            üìã Z datab√°ze
        </button>
        <button type="button" 
                onclick="switchDropdownMode('{{ field_name }}', 'add')"
                class="mode-btn mode-btn-add px-3 py-1 text-xs font-medium border rounded transition-colors"
                data-field="{{ field_name }}">
            ‚ûï P≈ôidat nov√Ω
        </button>
        <button type="button" 
                onclick="switchDropdownMode('{{ field_name }}', 'text')"
                class="mode-btn mode-btn-text px-3 py-1 text-xs font-medium border rounded transition-colors"
                data-field="{{ field_name }}">
            ‚úé Voln√Ω text
        </button>
    </div>

    <!-- Mode 1: Select from database -->
    <div class="mode-content mode-select" data-field="{{ field_name }}">
        <select id="{{ field_name }}" 
                name="{{ field_name }}"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option value="">-- Vyberte hodnotu --</option>
            <!-- Values will be loaded dynamically or from server -->
            {% if category %}
                {% for source in dropdown_sources.get(category, []) %}
                <option value="{{ source.value }}" {% if current_value == source.value %}selected{% endif %}>
                    {{ source.value }}
                </option>
                {% endfor %}
            {% endif %}
        </select>
    </div>

    <!-- Mode 2: Add new value -->
    <div class="mode-content mode-add hidden" data-field="{{ field_name }}">
        <div class="flex gap-2">
            <input type="text" 
                   id="{{ field_name }}_new"
                   placeholder="Zadejte novou hodnotu..."
                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
            <button type="button"
                    onclick="addNewDropdownValue('{{ field_name }}', '{{ category }}')"
                    class="px-4 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700">
                P≈ôidat a vybrat
            </button>
        </div>
        <p class="text-xs text-gray-500 mt-1">Hodnota bude ulo≈æena do datab√°ze a bude k dispozici i pro dal≈°√≠ pou≈æit√≠</p>
    </div>

    <!-- Mode 3: Free text -->
    <div class="mode-content mode-text hidden" data-field="{{ field_name }}">
        <input type="text" 
               id="{{ field_name }}_text"
               name="{{ field_name }}"
               value="{{ current_value or '' }}"
               placeholder="{{ placeholder or 'Zadejte hodnotu...' }}"
               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <p class="text-xs text-gray-500 mt-1">Hodnota se ulo≈æ√≠ pouze do tohoto z√°znamu, nebude p≈ôid√°na do datab√°ze hodnot</p>
    </div>

    {% if field_help %}
    <p class="mt-1 text-xs text-gray-500">{{ field_help }}</p>
    {% endif %}
</div>

<script>
// Switch between dropdown modes
function switchDropdownMode(fieldName, mode) {
    const container = document.querySelector(`.dropdown-widget-container[data-field="${fieldName}"]`);
    
    // Hide all mode contents
    container.querySelectorAll('.mode-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Remove active state from all buttons
    container.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
        btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
    });
    
    // Show selected mode content
    const selectedContent = container.querySelector(`.mode-${mode}[data-field="${fieldName}"]`);
    selectedContent.classList.remove('hidden');
    
    // Add active state to selected button
    const selectedBtn = container.querySelector(`.mode-btn-${mode}[data-field="${fieldName}"]`);
    selectedBtn.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
    selectedBtn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
    
    // Disable/enable form fields based on mode
    const selectField = container.querySelector(`select#${fieldName}`);
    const textField = container.querySelector(`input#${fieldName}_text`);
    
    if (mode === 'select') {
        selectField.disabled = false;
        if (textField) textField.disabled = true;
    } else if (mode === 'text') {
        selectField.disabled = true;
        if (textField) textField.disabled = false;
    } else {
        selectField.disabled = true;
        if (textField) textField.disabled = true;
    }
}

// Add new value to dropdown and select it
async function addNewDropdownValue(fieldName, category) {
    const container = document.querySelector(`.dropdown-widget-container[data-field="${fieldName}"]`);
    const newValueInput = container.querySelector(`#${fieldName}_new`);
    const value = newValueInput.value.trim();
    
    if (!value) {
        alert('Zadejte hodnotu');
        return;
    }
    
    try {
        // Send request to add new value
        const formData = new FormData();
        formData.append('value', value);
        
        const response = await fetch(`/api/dropdown/${category}/add`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Add new option to select
            const selectField = container.querySelector(`select#${fieldName}`);
            const newOption = document.createElement('option');
            newOption.value = data.value;
            newOption.text = data.value;
            newOption.selected = true;
            selectField.appendChild(newOption);
            
            // Switch back to select mode
            switchDropdownMode(fieldName, 'select');
            
            // Clear input
            newValueInput.value = '';
            
            // Show success message
            alert(`Hodnota "${data.value}" byla p≈ôid√°na a vybr√°na`);
        } else {
            alert('Chyba p≈ôi p≈ôid√°v√°n√≠ hodnoty: ' + (data.error || 'Nezn√°m√° chyba'));
        }
    } catch (error) {
        console.error('Error adding dropdown value:', error);
        alert('Chyba p≈ôi p≈ôid√°v√°n√≠ hodnoty');
    }
}

// Initialize first mode on page load
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.dropdown-widget-container').forEach(container => {
        const fieldName = container.getAttribute('data-field');
        // Start with select mode by default
        switchDropdownMode(fieldName, 'select');
    });
});
</script>

<style>
.dropdown-widget-container {
    position: relative;
}

.mode-btn {
    cursor: pointer;
}

.mode-btn:hover {
    opacity: 0.8;
}
</style>
