{#
  DYNAMICK√â VYKRESLOV√ÅN√ç STATIC KARET V DETAIL VIEW
  ==================================================
  Makra pro dynamick√© generov√°n√≠ karet v detail view podle field_configs.
  Respektuje enabled/disabled nastaven√≠ z dropdown_config.
  
  UNIFIED SYSTEM:
  - Stejn√© kategorie jako ve formul√°≈ô√≠ch
  - Generuje karty pouze pro kategorie s enabled poli
  - Pou≈æ√≠v√° field_config jako single source of truth
#}

{# ============================================================================
   MAKRO 1: render_static_field
   ============================================================================
   Vykresl√≠ jedno pole v static re≈æimu (read-only zobrazen√≠)
   
   Parametry:
   - field: dict s konfigurac√≠ pole (name, label, type)
   - entity: SQLAlchemy objekt s daty
   
   Pou≈æit√≠:
   {{ render_static_field(field, revision) }}
#}
{% macro render_static_field(field, entity) %}
    {# Z√≠skej hodnotu pole #}
    {% set field_value = entity[field.name] if entity and field.name in entity else None %}
    
    {# Zobraz pouze pokud m√° hodnotu #}
    {% if field_value %}
        <div>
            <dt class="text-xs text-gray-500 uppercase font-medium">{{ field.label }}</dt>
            <dd class="font-medium text-gray-900 mt-1">
                {# Form√°tov√°n√≠ podle typu #}
                {% if field.type == 'date' %}
                    {{ field_value.strftime('%d.%m.%Y') if field_value else '' }}
                {% elif field.type == 'number' %}
                    {{ field_value }}
                {% else %}
                    {{ field_value }}
                {% endif %}
            </dd>
        </div>
    {% endif %}
{% endmacro %}


{# ============================================================================
   MAKRO 2: render_static_card
   ============================================================================
   Vykresl√≠ kompletn√≠ static kartu pro jednu kategorii
   
   Parametry:
   - category_key: kl√≠ƒç kategorie ('basic', 'dates', apod.)
   - field_configs: list konfigurac√≠ pol√≠
   - entity: SQLAlchemy objekt s daty
   - card_id: ID elementu karty (pro HTMX swap)
   
   Pou≈æit√≠:
   {{ render_static_card('basic', field_configs, revision, 'card-basic') }}
#}
{% macro render_static_card(category_key, field_configs, entity, card_id) %}
    <div id="{{ card_id }}" class="p-4">
        <dl class="space-y-3">
            {% set has_content = false %}
            {% for field in field_configs %}
                {% if field.category == category_key %}
                    {% set field_value = entity[field.name] if entity and field.name in entity else None %}
                    {% if field_value %}
                        {% set has_content = true %}
                        {{ render_static_field(field, entity) }}
                    {% endif %}
                {% endif %}
            {% endfor %}
            
            {# Pokud kategorie nem√° ≈æ√°dn√° data, zobraz placeholder #}
            {% if not has_content %}
                <div class="text-gray-400 text-sm italic">
                    ≈Ω√°dn√© √∫daje
                </div>
            {% endif %}
        </dl>
    </div>
{% endmacro %}


{# ============================================================================
   MAKRO 3: render_entity_cards
   ============================================================================
   Vykresl√≠ v≈°echny karty pro entitu v detail view
   
   Parametry:
   - entity_type: typ entity ('revision', 'switchboard', apod.)
   - entity: SQLAlchemy objekt s daty
   - field_configs: list konfigurac√≠ pol√≠
   - collapsible: list kategori√≠, kter√© maj√≠ b√Ωt collapsible (voliteln√©)
   
   Pou≈æit√≠:
   {{ render_entity_cards('revision', revision, field_configs, ['administrative', 'technical']) }}
   
   Generuje kompletn√≠ karty vƒçetnƒõ:
   - Headeru s ikonou a n√°zvem
   - Edit tlaƒç√≠tka (HTMX)
   - Collapse funkce pro specifikovan√© kategorie
   - Dynamick√©ho obsahu podle field_config
#}
{% macro render_entity_cards(entity_type, entity, field_configs, collapsible=[]) %}
    {# Definice kategori√≠ s popisky #}
    {% set category_info = {
        'basic': {'label': 'Z√°kladn√≠ informace', 'icon': 'üìã', 'order': 10},
        'dates': {'label': 'Term√≠ny', 'icon': 'üìÖ', 'order': 20},
        'technical': {'label': 'Technick√© √∫daje', 'icon': 'üîß', 'order': 30},
        'administrative': {'label': 'Administrativn√≠ √∫daje', 'icon': 'üìÑ', 'order': 40},
        'measurements': {'label': 'Mƒõ≈ôen√≠', 'icon': 'üìä', 'order': 50}
    } %}
    
    {# Seskup pole podle kategori√≠ #}
    {% set fields_by_category = {} %}
    {% for field in field_configs %}
        {% set cat = field.category or 'other' %}
        {% if cat not in fields_by_category %}
            {% set _ = fields_by_category.update({cat: []}) %}
        {% endif %}
        {% set _ = fields_by_category[cat].append(field) %}
    {% endfor %}
    
    {# Se≈ôaƒè kategorie podle order #}
    {% set sorted_categories = [] %}
    {% for cat_key, cat_data in category_info.items() %}
        {% if cat_key in fields_by_category %}
            {% set _ = sorted_categories.append((cat_key, cat_data, fields_by_category[cat_key])) %}
        {% endif %}
    {% endfor %}
    {% set sorted_categories = sorted_categories|sort(attribute='1.order') %}
    
    {# Vykreslen√≠ jednotliv√Ωch karet #}
    {% for cat_key, cat_data, cat_fields in sorted_categories %}
        {% set is_collapsible = cat_key in collapsible %}
        {% set card_id = 'card-' ~ cat_key %}
        {% set content_id = 'content-' ~ cat_key %}
        {% set icon_id = 'icon-' ~ cat_key %}
        
        <!-- {{ cat_data.icon }} {{ cat_data.label }} Card -->
        <div class="card bg-white border border-gray-200 rounded-lg overflow-hidden">
            <div class="card-header bg-gray-50 px-4 py-3 flex items-center justify-between border-b border-gray-200 {% if is_collapsible %}cursor-pointer{% endif %}"
                 {% if is_collapsible %}onclick="toggleCard('{{ cat_key }}')"{% endif %}>
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        {# Ikony podle typu - m≈Ø≈æe≈° doplnit v√≠ce ikon #}
                        {% if cat_key == 'basic' %}
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        {% elif cat_key == 'dates' %}
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        {% elif cat_key == 'technical' %}
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        {% elif cat_key == 'administrative' %}
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        {% else %}
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        {% endif %}
                    </svg>
                    <h3 class="font-semibold text-gray-900">{{ cat_data.label }}</h3>
                </div>
                <div class="flex items-center space-x-2">
                    <button 
                        hx-get="/{{ entity_type }}/{{ entity[entity_type ~ '_id'] }}/edit-card/{{ cat_key }}"
                        hx-target="#{{ card_id }}"
                        hx-swap="outerHTML"
                        {% if is_collapsible %}onclick="event.stopPropagation();"{% endif %}
                        class="text-gray-400 hover:text-primary transition p-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                        </svg>
                    </button>
                    {% if is_collapsible %}
                        <svg id="{{ icon_id }}" class="w-5 h-5 transform transition-transform text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    {% endif %}
                </div>
            </div>
            
            {# Content wrapper - collapsible nebo norm√°ln√≠ #}
            {% if is_collapsible %}
                <div id="{{ content_id }}" class="hidden">
                    <div 
                        id="{{ card_id }}"
                        hx-get="/{{ entity_type }}/{{ entity[entity_type ~ '_id'] }}/card/{{ cat_key }}"
                        hx-trigger="revealed"
                        hx-swap="outerHTML">
                        <!-- Loading state -->
                        <div class="p-4 text-center text-gray-400 text-sm">
                            Naƒç√≠t√°m...
                        </div>
                    </div>
                </div>
            {% else %}
                <div 
                    id="{{ card_id }}"
                    hx-get="/{{ entity_type }}/{{ entity[entity_type ~ '_id'] }}/card/{{ cat_key }}"
                    hx-trigger="load"
                    hx-swap="outerHTML">
                    <!-- Loading state -->
                    <div class="p-4 text-center text-gray-400 text-sm">
                        Naƒç√≠t√°m...
                    </div>
                </div>
            {% endif %}
        </div>
        
    {% endfor %}
{% endmacro %}


{# ============================================================================
   JAVASCRIPT PRO COLLAPSIBLE KARTY
   ============================================================================
   Mus√≠ b√Ωt p≈ô√≠tomn√Ω v base.html nebo v ka≈æd√©m detail view
#}
<script>
function toggleCard(cardKey) {
    const content = document.getElementById('content-' + cardKey);
    const icon = document.getElementById('icon-' + cardKey);
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.classList.add('rotate-180');
        
        // Trigger HTMX load if not loaded yet
        const cardElement = document.getElementById('card-' + cardKey);
        if (cardElement && cardElement.innerHTML.includes('Naƒç√≠t√°m')) {
            htmx.trigger(cardElement, 'revealed');
        }
    } else {
        content.classList.add('hidden');
        icon.classList.remove('rotate-180');
    }
}
</script>
