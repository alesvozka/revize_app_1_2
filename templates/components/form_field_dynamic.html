{# 
  PHASE 4: Dynamic Field Rendering Macro
  
  Renders form fields based on field configuration
  Only displays enabled fields in configured order
#}

{% macro render_dynamic_field(field, entity_obj=None, dropdown_sources={}, error_fields=[]) %}
  {# Get current value from entity object - using getattr for safe attribute access #}
  {% set current_value = entity_obj | attr(field.name) if entity_obj and (field.name in entity_obj.__dict__ or hasattr(entity_obj, field.name)) else '' %}
  {% set has_error = field.name in error_fields %}
  
  <div class="form-group">
    {# Render based on field type and dropdown config #}
    {% if field.has_dropdown and field.dropdown_category %}
      {# Dropdown with widget - Set variables for inclusion #}
      {% set field_name = field.name %}
      {% set field_label = field.label %}
      {% if field.required %}{% set field_label = field_label ~ ' *' %}{% endif %}
      {% set category = field.dropdown_category %}
      {% set placeholder = 'Vyberte nebo zadejte hodnotu...' %}
      
      {% include 'components/dropdown_widget_compact.html' with context %}
      
    {% else %}
      {# Regular fields without dropdown #}
      <label class="block text-sm font-medium text-gray-700 mb-1.5">
        {{ field.label }}
        {% if field.required %}
          <span class="text-red-500">*</span>
        {% endif %}
      </label>
      
      {% if field.type == 'textarea' %}
        {# Textarea #}
        <textarea 
          name="{{ field.name }}" 
          id="{{ field.name }}"
          rows="3"
          {% if field.required %}required{% endif %}
          class="w-full px-3 py-2 border {% if has_error %}border-red-500{% else %}border-gray-300{% endif %} rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        >{{ current_value or '' }}</textarea>
        
      {% elif field.type == 'date' %}
        {# Date input #}
        <input 
          type="date" 
          name="{{ field.name }}" 
          id="{{ field.name }}"
          value="{% if current_value and current_value is not none %}{% if current_value.strftime is defined %}{{ current_value.strftime('%Y-%m-%d') }}{% else %}{{ current_value }}{% endif %}{% endif %}"
          {% if field.required %}required{% endif %}
          class="w-full px-3 py-2 border {% if has_error %}border-red-500{% else %}border-gray-300{% endif %} rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        
      {% elif field.type == 'number' %}
        {# Number input #}
        <input 
          type="number" 
          name="{{ field.name }}" 
          id="{{ field.name }}"
          value="{{ current_value or '' }}"
          step="any"
          {% if field.required %}required{% endif %}
          class="w-full px-3 py-2 border {% if has_error %}border-red-500{% else %}border-gray-300{% endif %} rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        
      {% else %}
        {# Text input (default) #}
        <input 
          type="text" 
          name="{{ field.name }}" 
          id="{{ field.name }}"
          value="{{ current_value or '' }}"
          {% if field.required %}required{% endif %}
          class="w-full px-3 py-2 border {% if has_error %}border-red-500{% else %}border-gray-300{% endif %} rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
      {% endif %}
      
      {% if has_error %}
        <p class="mt-1 text-sm text-red-500">Toto pole je povinné</p>
      {% endif %}
    {% endif %}
  </div>
{% endmacro %}


{% macro render_entity_form(entity_type, field_configs, entity_obj=None, dropdown_sources={}) %}
  {#
    Main macro to render a complete form for an entity
    Groups fields by category and renders them in sections
  #}
  
  {# Group fields by category #}
  {% set basic_fields = [] %}
  {% set additional_fields = [] %}
  
  {% for field in field_configs %}
    {% if field.category == 'basic' %}
      {% set _ = basic_fields.append(field) %}
    {% else %}
      {% set _ = additional_fields.append(field) %}
    {% endif %}
  {% endfor %}
  
  {# Render Basic Fields Section #}
  {% if basic_fields %}
  <div class="mb-8">
    <h3 class="text-lg font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-200">
      Základní údaje
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      {% for field in basic_fields %}
        {{ render_dynamic_field(field, entity_obj, dropdown_sources) }}
      {% endfor %}
    </div>
  </div>
  {% endif %}
  
  {# Render Additional Fields Section #}
  {% if additional_fields %}
  <div class="mb-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-200">
      Dodatečné údaje
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      {% for field in additional_fields %}
        {{ render_dynamic_field(field, entity_obj, dropdown_sources) }}
      {% endfor %}
    </div>
  </div>
  {% endif %}
  
{% endmacro %}
