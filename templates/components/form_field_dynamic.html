{#
  DYNAMICK√â VYKRESLOV√ÅN√ç FORMUL√Å≈òOV√ùCH POL√ç
  ==========================================
  Makra pro vykreslov√°n√≠ formul√°≈ô≈Ø podle field_configs z datab√°ze.
  Podporuje:
  - R≈Øzn√© typy pol√≠ (text, textarea, number, date)
  - Dropdown hodnoty z datab√°ze
  - Kategorizaci pol√≠
  - Vlastn√≠ labely (custom_label)
  - Povinn√° pole (is_required)
#}

{# ============================================================================
   MAKRO 1: render_dynamic_field
   ============================================================================
   Vykresl√≠ jedno pole podle jeho konfigurace
   
   Parametry:
   - field: dict s konfigurac√≠ pole (name, label, type, required, has_dropdown, dropdown_category)
   - entity: SQLAlchemy objekt s daty (revision, switchboard, apod.)
   - dropdown_sources: dict s dropdown hodnotami gruppovan√Ωmi podle kategorie
   
   Pou≈æit√≠:
   {{ render_dynamic_field(field, revision, dropdown_sources) }}
#}
{% macro render_dynamic_field(field, entity, dropdown_sources) %}
    <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
            {{ field.label }}{% if field.required %} *{% endif %}
        </label>
        
        {% set field_value = entity[field.name] if entity and field.name in entity else '' %}
        
        {# DROPDOWN POLE #}
        {% if field.has_dropdown and field.dropdown_category and field.dropdown_category in dropdown_sources %}
            <div class="dropdown-wrapper relative">
                <select 
                    name="{{ field.name }}"
                    {% if field.required %}required{% endif %}
                    class="dropdown-select w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent appearance-none bg-white"
                    data-category="{{ field.dropdown_category }}"
                    onchange="handleDropdownChange(this)">
                    
                    <option value="">-- Vyberte --</option>
                    
                    {% for source in dropdown_sources[field.dropdown_category] %}
                        <option value="{{ source.value }}" 
                                {% if field_value == source.value %}selected{% endif %}>
                            {{ source.value }}
                        </option>
                    {% endfor %}
                    
                    <option value="__ADD_NEW__">‚ûï P≈ôidat novou hodnotu...</option>
                    <option value="__FREE_TEXT__">‚úèÔ∏è Vlastn√≠ text...</option>
                </select>
                
                {# Hidden input for free text #}
                <input 
                    type="text"
                    name="{{ field.name }}_free_text"
                    class="dropdown-free-text hidden w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                    placeholder="Zadejte vlastn√≠ hodnotu"
                    value="{{ field_value if field_value not in [source.value for source in dropdown_sources[field.dropdown_category]] else '' }}">
                
                {# Dropdown icon #}
                <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </div>
        
        {# TEXTAREA #}
        {% elif field.type == 'textarea' %}
            <textarea 
                name="{{ field.name }}"
                {% if field.required %}required{% endif %}
                rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">{{ field_value or '' }}</textarea>
        
        {# NUMBER #}
        {% elif field.type == 'number' %}
            <input 
                type="number"
                name="{{ field.name }}"
                value="{{ field_value if field_value is not none else '' }}"
                {% if field.required %}required{% endif %}
                step="any"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
        
        {# DATE #}
        {% elif field.type == 'date' %}
            <input 
                type="date"
                name="{{ field.name }}"
                value="{{ field_value if field_value else '' }}"
                {% if field.required %}required{% endif %}
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
        
        {# TEXT (default) #}
        {% else %}
            <input 
                type="text"
                name="{{ field.name }}"
                value="{{ field_value or '' }}"
                {% if field.required %}required{% endif %}
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
        {% endif %}
    </div>
{% endmacro %}


{# ============================================================================
   MAKRO 2: render_entity_form
   ============================================================================
   Vykresl√≠ cel√Ω formul√°≈ô entity s kategorizac√≠ pol√≠ do karet
   
   Parametry:
   - entity_type: typ entity ('revision', 'switchboard', apod.)
   - field_configs: list konfigurac√≠ pol√≠
   - entity: SQLAlchemy objekt s daty (nebo None pro novou entitu)
   - dropdown_sources: dict s dropdown hodnotami
   
   Pou≈æit√≠:
   {{ render_entity_form('revision', field_configs, revision, dropdown_sources) }}
#}
{% macro render_entity_form(entity_type, field_configs, entity, dropdown_sources) %}
    {# Seskupen√≠ pol√≠ podle kategori√≠ #}
    {% set fields_by_category = {} %}
    {% for field in field_configs %}
        {% set cat = field.category or 'other' %}
        {% if cat not in fields_by_category %}
            {% set _ = fields_by_category.update({cat: []}) %}
        {% endif %}
        {% set _ = fields_by_category[cat].append(field) %}
    {% endfor %}
    
    {# Definice kategori√≠ s popisky #}
    {% set category_labels = {
        'basic': {'label': 'Z√°kladn√≠ informace', 'icon': 'üìã'},
        'additional': {'label': 'Dodateƒçn√© √∫daje', 'icon': 'üìù'},
        'technical': {'label': 'Technick√© √∫daje', 'icon': 'üîß'},
        'administrative': {'label': 'Administrativn√≠ √∫daje', 'icon': 'üìÑ'},
        'measurements': {'label': 'Mƒõ≈ôen√≠', 'icon': 'üìä'},
        'other': {'label': 'Ostatn√≠', 'icon': 'üì¶'}
    } %}
    
    {# Vykreslen√≠ kategori√≠ v po≈ôad√≠ #}
    {% set category_order = ['basic', 'additional', 'technical', 'administrative', 'measurements', 'other'] %}
    
    {% for category_key in category_order %}
        {% if category_key in fields_by_category %}
            {% set category_info = category_labels.get(category_key, {'label': category_key|title, 'icon': 'üìã'}) %}
            
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 pb-2 border-b flex items-center gap-2">
                    <span>{{ category_info.icon }}</span>
                    <span>{{ category_info.label }}</span>
                    <span class="text-sm font-normal text-gray-500">({{ fields_by_category[category_key]|length }} pol√≠)</span>
                </h3>
                
                <div class="space-y-4">
                    {% for field in fields_by_category[category_key] %}
                        {{ render_dynamic_field(field, entity, dropdown_sources) }}
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    {% endfor %}
{% endmacro %}


{# ============================================================================
   MAKRO 3: render_field_card_edit
   ============================================================================
   Vykresl√≠ edit kartu s poli konkr√©tn√≠ kategorie (pro inline editing)
   
   Parametry:
   - entity_type: typ entity
   - category: kl√≠ƒç kategorie ('basic', 'additional', apod.)
   - field_configs: list konfigurac√≠ pol√≠
   - entity: SQLAlchemy objekt s daty
   - dropdown_sources: dict s dropdown hodnotami
   
   Pou≈æit√≠ v edit kartƒõ:
   {{ render_field_card_edit('revision', 'basic', field_configs, revision, dropdown_sources) }}
#}
{% macro render_field_card_edit(entity_type, category, field_configs, entity, dropdown_sources) %}
    <div class="space-y-3">
        {% for field in field_configs %}
            {% if field.category == category %}
                {{ render_dynamic_field(field, entity, dropdown_sources) }}
            {% endif %}
        {% endfor %}
    </div>
{% endmacro %}


{# ============================================================================
   JAVASCRIPT PRO DROPDOWN HANDLING
   ============================================================================
   Mus√≠ b√Ωt p≈ô√≠tomn√Ω v base.html nebo v ka≈æd√©m formul√°≈ôi
#}
<script>
function handleDropdownChange(selectElement) {
    const wrapper = selectElement.closest('.dropdown-wrapper');
    const freeTextInput = wrapper.querySelector('.dropdown-free-text');
    const selectedValue = selectElement.value;
    
    if (selectedValue === '__FREE_TEXT__') {
        // P≈ôepnut√≠ na free text input
        selectElement.classList.add('hidden');
        freeTextInput.classList.remove('hidden');
        freeTextInput.focus();
        
        // Zmƒõna name aby se odeslal free text
        const originalName = selectElement.name;
        selectElement.name = originalName + '_dropdown_disabled';
        freeTextInput.name = originalName;
        
    } else if (selectedValue === '__ADD_NEW__') {
        // Modal pro p≈ôid√°n√≠ nov√© hodnoty
        const category = selectElement.dataset.category;
        const newValue = prompt('Zadejte novou hodnotu pro kategorii ' + category + ':');
        
        if (newValue && newValue.trim()) {
            // P≈ôid√°n√≠ hodnoty do selectu
            const newOption = document.createElement('option');
            newOption.value = newValue.trim();
            newOption.text = newValue.trim();
            newOption.selected = true;
            
            // Vlo≈æen√≠ p≈ôed "P≈ôidat novou hodnotu"
            const addNewOption = selectElement.querySelector('option[value="__ADD_NEW__"]');
            selectElement.insertBefore(newOption, addNewOption);
            
            // Odesl√°n√≠ na server pro ulo≈æen√≠ do dropdown_sources
            fetch('/settings/dropdown/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({
                    category: category,
                    value: newValue.trim()
                })
            }).then(response => response.json())
              .then(data => {
                  if (!data.success) {
                      console.error('Nepoda≈ôilo se ulo≈æit hodnotu:', data.error);
                  }
              });
        } else {
            // U≈æivatel zru≈°il, vr√°tit na pr√°zdnou hodnotu
            selectElement.value = '';
        }
    }
}

// Event listener pro n√°vrat z free text na dropdown
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.dropdown-free-text').forEach(input => {
        input.addEventListener('blur', function(e) {
            // Pokud je input pr√°zdn√Ω, vr√°tit zpƒõt dropdown
            if (!this.value.trim()) {
                const wrapper = this.closest('.dropdown-wrapper');
                const selectElement = wrapper.querySelector('.dropdown-select');
                
                this.classList.add('hidden');
                selectElement.classList.remove('hidden');
                
                // Obnovit name
                const originalName = this.name;
                selectElement.name = originalName;
                this.name = originalName + '_free_text';
                selectElement.value = '';
            }
        });
    });
});
</script>
