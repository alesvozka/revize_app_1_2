<!-- Quick Entry - Step 2: Rozváděče -->
<form hx-post="/api/quick-entry/complete"
      hx-target="#modal-body"
      hx-swap="innerHTML"
      class="p-4 space-y-4"
      onsubmit="return serializeSwitchboards()">
    
    <!-- Info o revizi -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
        <p class="text-sm text-blue-900">
            <span class="font-semibold">Revize:</span> {{ revision_name }}
        </p>
    </div>
    
    <!-- Quick Add Buttons -->
    <div class="space-y-2">
        <label class="block text-sm font-medium text-gray-700">
            Kolik rozváděčů přidat?
        </label>
        <div class="flex flex-wrap gap-2">
            <button 
                type="button" 
                onclick="addSwitchboards(1)"
                class="quick-btn px-4 py-2 border-2 border-gray-300 rounded-lg text-gray-700 font-medium hover:border-primary hover:text-primary hover:bg-blue-50 transition-all active:scale-95">
                1
            </button>
            <button 
                type="button" 
                onclick="addSwitchboards(2)"
                class="quick-btn px-4 py-2 border-2 border-gray-300 rounded-lg text-gray-700 font-medium hover:border-primary hover:text-primary hover:bg-blue-50 transition-all active:scale-95">
                2
            </button>
            <button 
                type="button" 
                onclick="addSwitchboards(3)"
                class="quick-btn px-4 py-2 border-2 border-gray-300 rounded-lg text-gray-700 font-medium hover:border-primary hover:text-primary hover:bg-blue-50 transition-all active:scale-95">
                3
            </button>
            <button 
                type="button" 
                onclick="addSwitchboards(5)"
                class="quick-btn px-4 py-2 border-2 border-gray-300 rounded-lg text-gray-700 font-medium hover:border-primary hover:text-primary hover:bg-blue-50 transition-all active:scale-95">
                5
            </button>
            <button 
                type="button" 
                onclick="addSwitchboards(10)"
                class="quick-btn px-4 py-2 border-2 border-gray-300 rounded-lg text-gray-700 font-medium hover:border-primary hover:text-primary hover:bg-blue-50 transition-all active:scale-95">
                10
            </button>
        </div>
    </div>
    
    <!-- Switchboard Forms Container -->
    <div id="switchboard-forms" class="space-y-3">
        <!-- Dynamically added switchboard forms will go here -->
    </div>
    
    <!-- Add More Button -->
    <button 
        type="button"
        onclick="addSwitchboard()"
        class="w-full px-4 py-2.5 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 font-medium hover:border-primary hover:text-primary hover:bg-blue-50 transition-all active:scale-95 flex items-center justify-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
        </svg>
        Přidat další rozváděč
    </button>
    
    <!-- Hidden field for JSON data -->
    <input type="hidden" name="switchboards" id="switchboards-data">
    
    <!-- Form Actions -->
    <div class="flex gap-3 pt-2 border-t border-gray-200">
        <button 
            type="button"
            onclick="goBackToStep1()"
            class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition-colors active:scale-95 flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Zpět
        </button>
        <button 
            type="submit"
            class="flex-1 px-4 py-2.5 bg-green-500 text-white rounded-lg font-medium hover:bg-green-600 transition-colors active:scale-95 flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Dokončit
        </button>
    </div>
    
</form>

<script>
// Switchboard counter
let switchboardCounter = 0;

// Add N switchboards at once
function addSwitchboards(count) {
    for (let i = 0; i < count; i++) {
        addSwitchboard();
    }
}

// Add single switchboard form
function addSwitchboard() {
    const container = document.getElementById('switchboard-forms');
    const index = switchboardCounter;
    
    const template = `
        <div class="switchboard-form border border-gray-200 rounded-lg p-3 bg-gray-50" data-index="${index}">
            <div class="flex items-center justify-between mb-3">
                <h4 class="text-sm font-semibold text-gray-900">Rozváděč ${index + 1}</h4>
                <button 
                    type="button" 
                    onclick="removeSwitchboard(${index})"
                    class="text-red-500 hover:text-red-700 hover:bg-red-50 rounded p-1 transition-colors"
                    aria-label="Odstranit rozváděč">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-2">
                <!-- Název rozváděče -->
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">
                        Název <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="text" 
                        name="sb_name_${index}" 
                        required
                        placeholder="např. Hlavní rozváděč"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-base">
                </div>
                
                <!-- Typ rozváděče -->
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">
                        Typ
                    </label>
                    <select 
                        name="sb_type_${index}"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-base">
                        <option value="">-- Volitelné --</option>
                        {% for option in switchboard_types %}
                        <option value="{{ option }}">{{ option }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', template);
    switchboardCounter++;
    
    // Auto-focus on first input of newly added form
    const newForm = container.lastElementChild;
    const firstInput = newForm.querySelector('input[type="text"]');
    if (firstInput) {
        firstInput.focus();
    }
}

// Remove switchboard form
function removeSwitchboard(index) {
    const form = document.querySelector(`[data-index="${index}"]`);
    if (form) {
        form.style.opacity = '0';
        form.style.transform = 'scale(0.95)';
        setTimeout(() => {
            form.remove();
            renumberSwitchboards();
        }, 200);
    }
}

// Renumber switchboards after deletion
function renumberSwitchboards() {
    const forms = document.querySelectorAll('.switchboard-form');
    forms.forEach((form, idx) => {
        const heading = form.querySelector('h4');
        if (heading) {
            heading.textContent = `Rozváděč ${idx + 1}`;
        }
    });
}

// Serialize all switchboards to JSON before submit
function serializeSwitchboards() {
    const forms = document.querySelectorAll('.switchboard-form');
    const switchboards = [];
    
    forms.forEach((form, index) => {
        const formIndex = form.getAttribute('data-index');
        const nameInput = form.querySelector(`[name="sb_name_${formIndex}"]`);
        const typeSelect = form.querySelector(`[name="sb_type_${formIndex}"]`);
        
        if (nameInput && nameInput.value.trim()) {
            switchboards.push({
                name: nameInput.value.trim(),
                type: typeSelect ? typeSelect.value : '',
                order: index
            });
        }
    });
    
    if (switchboards.length === 0) {
        alert('Přidejte alespoň jeden rozváděč!');
        return false;
    }
    
    document.getElementById('switchboards-data').value = JSON.stringify(switchboards);
    return true;
}

// Go back to step 1
function goBackToStep1() {
    updateStepper(1);
    htmx.ajax('GET', '/api/quick-entry/step1', {
        target: '#modal-body',
        swap: 'innerHTML'
    });
}

// Initialize with 1 switchboard by default
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('switchboard-forms')) {
        addSwitchboard();
    }
});
</script>

<style>
.switchboard-form {
    transition: all 0.2s ease;
}

.switchboard-form:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* Quick button hover effect */
.quick-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
}

.quick-btn:active {
    transform: translateY(0);
}
</style>
