{% extends "base.html" %}

{% block title %}Nastaven√≠ - Revize App{% endblock %}

{% block content %}
<style>
    /* Flat design overrides */
    .settings-card {
        border: 1px solid #e5e7eb;
        box-shadow: none;
    }
    
    .settings-card:hover {
        border-color: #d1d5db;
    }
    
    .tab-active {
        background-color: #FDB913;
        color: #000;
        border-bottom: 3px solid #FDB913;
    }
    
    .tab-inactive {
        color: #6b7280;
        border-bottom: 3px solid transparent;
    }
    
    .tab-inactive:hover {
        color: #111827;
        background-color: #f9fafb;
    }
    
    .badge {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        font-size: 12px;
        font-weight: 500;
        border-radius: 9999px;
    }
    
    .badge-yellow {
        background-color: #fef3c7;
        color: #92400e;
    }
    
    .badge-blue {
        background-color: #dbeafe;
        color: #1e40af;
    }
    
    .badge-gray {
        background-color: #f3f4f6;
        color: #374151;
    }
    
    .icon-btn {
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.15s;
    }
    
    .icon-btn:hover {
        background-color: #f3f4f6;
    }
</style>

<div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">‚öôÔ∏è Nastaven√≠</h1>
        <p class="text-gray-600">Konfigurace aplikace a spr√°va formul√°≈ôov√Ωch pol√≠</p>
    </div>

    <!-- Main Settings Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Left: Entity Selector -->
        <div class="lg:col-span-1">
            <div class="settings-card bg-white rounded-lg overflow-hidden sticky top-4">
                <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                    <h2 class="font-semibold text-gray-900">Entity</h2>
                </div>
                <div class="p-2">
                    <button onclick="showEntity('revision')" id="btn-revision" 
                            class="entity-btn w-full text-left px-4 py-3 rounded hover:bg-gray-50 transition flex items-center gap-3 mb-1">
                        <span class="text-2xl">üìã</span>
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">Revize</div>
                            <div class="text-xs text-gray-500" id="count-revision">0 pol√≠</div>
                        </div>
                    </button>
                    
                    <button onclick="showEntity('switchboard')" id="btn-switchboard"
                            class="entity-btn w-full text-left px-4 py-3 rounded hover:bg-gray-50 transition flex items-center gap-3 mb-1">
                        <span class="text-2xl">üì¶</span>
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">Rozv√°dƒõƒç</div>
                            <div class="text-xs text-gray-500" id="count-switchboard">0 pol√≠</div>
                        </div>
                    </button>
                    
                    <button onclick="showEntity('device')" id="btn-device"
                            class="entity-btn w-full text-left px-4 py-3 rounded hover:bg-gray-50 transition flex items-center gap-3 mb-1">
                        <span class="text-2xl">üîå</span>
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">P≈ô√≠stroj</div>
                            <div class="text-xs text-gray-500" id="count-device">0 pol√≠</div>
                        </div>
                    </button>
                    
                    <button onclick="showEntity('circuit')" id="btn-circuit"
                            class="entity-btn w-full text-left px-4 py-3 rounded hover:bg-gray-50 transition flex items-center gap-3 mb-1">
                        <span class="text-2xl">‚ö°</span>
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">Obvod</div>
                            <div class="text-xs text-gray-500" id="count-circuit">0 pol√≠</div>
                        </div>
                    </button>
                    
                    <button onclick="showEntity('terminal_device')" id="btn-terminal_device"
                            class="entity-btn w-full text-left px-4 py-3 rounded hover:bg-gray-50 transition flex items-center gap-3">
                        <span class="text-2xl">üí°</span>
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">Koncov√© za≈ô√≠zen√≠</div>
                            <div class="text-xs text-gray-500" id="count-terminal_device">0 pol√≠</div>
                        </div>
                    </button>
                </div>
                
                <!-- Dropdowns Link -->
                <div class="border-t border-gray-200 p-4">
                    <a href="#dropdowns" onclick="showDropdownManager()" 
                       class="flex items-center gap-2 text-sm text-gray-700 hover:text-gray-900">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                        <span>Spr√°va dropdown≈Ø</span>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Right: Content Area -->
        <div class="lg:col-span-2">
            <!-- Entity Configuration Panels -->
            {% for entity_type in ['revision', 'switchboard', 'device', 'circuit', 'terminal_device'] %}
            <div id="entity-{{ entity_type }}" class="entity-panel hidden">
                <div class="settings-card bg-white rounded-lg overflow-hidden mb-6">
                    <!-- Tabs -->
                    <div class="border-b border-gray-200 bg-gray-50">
                        <div class="flex">
                            <button onclick="showTab('{{ entity_type }}', 'fields')" 
                                    id="tab-{{ entity_type }}-fields"
                                    class="entity-tab tab-active px-6 py-3 font-medium text-sm transition">
                                üìù Pole formul√°≈ôe
                            </button>
                            <button onclick="showTab('{{ entity_type }}', 'dropdowns')" 
                                    id="tab-{{ entity_type }}-dropdowns"
                                    class="entity-tab tab-inactive px-6 py-3 font-medium text-sm transition">
                                üìã Dropdowny
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tab Content: Fields -->
                    <div id="content-{{ entity_type }}-fields" class="tab-content p-6">
                        <div class="mb-4">
                            <h3 class="text-lg font-semibold text-gray-900 mb-1">Viditelnost pol√≠</h3>
                            <p class="text-sm text-gray-600">Zapni/vypni pole, kter√° chce≈° vidƒõt ve formul√°≈ô√≠ch</p>
                        </div>
                        
                        <!-- Fields by Category -->
                        {% set entity_fields = field_configs | selectattr('entity_type', 'equalto', entity_type) | list %}
                        {% set categories = entity_fields | map(attribute='category') | unique | list %}
                        
                        {% for category in ['basic', 'additional', 'technical', 'administrative', 'measurements'] %}
                            {% set cat_fields = entity_fields | selectattr('category', 'equalto', category) | list %}
                            {% if cat_fields %}
                            <div class="mb-6">
                                <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                    {% if category == 'basic' %}üîµ Z√°kladn√≠ pole
                                    {% elif category == 'additional' %}üìé Dodateƒçn√© pole
                                    {% elif category == 'technical' %}‚öôÔ∏è Technick√© pole
                                    {% elif category == 'administrative' %}üìë Administrativn√≠ pole
                                    {% elif category == 'measurements' %}üìè Mƒõ≈ôen√≠
                                    {% endif %}
                                    <span class="badge badge-gray">{{ cat_fields | length }}</span>
                                </h4>
                                
                                <div class="space-y-2">
                                    {% for field in cat_fields %}
                                    <div class="flex items-center gap-3 p-3 rounded border border-gray-200 hover:border-gray-300 transition">
                                        <!-- Toggle -->
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" 
                                                   {% if field.enabled %}checked{% endif %}
                                                   {% if field.required %}disabled{% endif %}
                                                   onchange="toggleField('{{ field.id }}', this.checked)"
                                                   class="sr-only peer">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:ring-2 peer-focus:ring-yellow-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#FDB913]"></div>
                                        </label>
                                        
                                        <!-- Field Info -->
                                        <div class="flex-1 min-w-0">
                                            <div class="font-medium text-gray-900 text-sm flex items-center gap-2">
                                                {{ field.label }}
                                                {% if field.required %}
                                                <span class="badge badge-yellow">Povinn√©</span>
                                                {% endif %}
                                                {% if field.dropdown_enabled %}
                                                <span class="badge badge-blue">Dropdown</span>
                                                {% endif %}
                                            </div>
                                            <div class="text-xs text-gray-500 font-mono">{{ field.name }}</div>
                                        </div>
                                        
                                        <!-- Status -->
                                        <div class="text-sm">
                                            {% if field.enabled %}
                                            <span class="text-green-600">‚óè</span>
                                            {% else %}
                                            <span class="text-gray-300">‚óè</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    
                    <!-- Tab Content: Dropdowns -->
                    <div id="content-{{ entity_type }}-dropdowns" class="tab-content p-6 hidden">
                        <div class="mb-4">
                            <h3 class="text-lg font-semibold text-gray-900 mb-1">Konfigurace dropdown≈Ø</h3>
                            <p class="text-sm text-gray-600">P≈ôi≈ôaƒè dropdownov√© seznamy k jednotliv√Ωm pol√≠m</p>
                        </div>
                        
                        {% set dropdown_fields = configurable_fields.get(entity_type, {}) %}
                        {% if dropdown_fields %}
                        <div class="space-y-3">
                            {% for field_name, field_label in dropdown_fields.items() %}
                            {% set config_key = entity_type ~ '_' ~ field_name %}
                            {% set config = configs_dict.get(config_key) %}
                            
                            <form method="POST" action="{{ url_for('dropdown_config_update') }}" 
                                  class="flex items-center gap-3 p-3 rounded border border-gray-200 hover:border-gray-300 transition">
                                <input type="hidden" name="entity_type" value="{{ entity_type }}">
                                <input type="hidden" name="field_name" value="{{ field_name }}">
                                
                                <!-- Enable Checkbox -->
                                <input type="checkbox" 
                                       name="dropdown_enabled"
                                       id="dropdown_{{ config_key }}"
                                       {% if config and config.dropdown_enabled %}checked{% endif %}
                                       onchange="toggleDropdownCategory('{{ config_key }}')"
                                       class="w-4 h-4 text-yellow-600 border-gray-300 rounded focus:ring-yellow-500">
                                
                                <!-- Field Label -->
                                <div class="flex-1 min-w-0">
                                    <label for="dropdown_{{ config_key }}" class="font-medium text-sm text-gray-900 cursor-pointer">
                                        {{ field_label }}
                                    </label>
                                    <div class="text-xs text-gray-500 font-mono">{{ field_name }}</div>
                                </div>
                                
                                <!-- Category Select -->
                                <select name="dropdown_category"
                                        id="category_{{ config_key }}"
                                        {% if not config or not config.dropdown_enabled %}disabled{% endif %}
                                        class="px-3 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-yellow-500 disabled:bg-gray-100 disabled:text-gray-400">
                                    <option value="">-- Kategorie --</option>
                                    {% for category in categories %}
                                    <option value="{{ category }}" 
                                            {% if config and config.dropdown_category == category %}selected{% endif %}>
                                        {{ category }}
                                    </option>
                                    {% endfor %}
                                </select>
                                
                                <!-- Save Button -->
                                <button type="submit" 
                                        class="px-4 py-1.5 bg-[#FDB913] text-gray-900 text-sm font-medium rounded hover:bg-[#f0ad00] transition">
                                    Ulo≈æit
                                </button>
                            </form>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-8 text-gray-500">
                            <svg class="w-12 h-12 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <p>Pro tuto entitu nejsou k dispozici konfigurovateln√° pole</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
            
            <!-- Dropdown Manager Panel -->
            <div id="dropdown-manager" class="hidden">
                <div class="settings-card bg-white rounded-lg overflow-hidden">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900">Spr√°va dropdownov√Ωch seznam≈Ø</h2>
                            <p class="text-sm text-gray-600 mt-1">P≈ôidej kategorie a hodnoty pro dropdowny</p>
                        </div>
                        <button onclick="showEntity('revision')" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="p-6">
                        <!-- Add Category -->
                        <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded">
                            <h3 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Nov√° kategorie
                            </h3>
                            <form method="POST" action="{{ url_for('dropdown_category_create') }}" class="flex gap-3">
                                <input type="text" 
                                       name="category" 
                                       placeholder="nap≈ô. vyrobci_kabelu"
                                       required
                                       class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                <button type="submit" 
                                        class="px-5 py-2 bg-[#FDB913] text-gray-900 text-sm font-medium rounded hover:bg-[#f0ad00] transition">
                                    Vytvo≈ôit
                                </button>
                            </form>
                        </div>
                        
                        <!-- Categories Grid -->
                        {% if categories %}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {% for category in categories %}
                            <div class="border border-gray-200 rounded p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-semibold text-gray-900 flex items-center gap-2">
                                        {{ category }}
                                        <span class="badge badge-gray">{{ dropdown_sources[category]|length }}</span>
                                    </h4>
                                </div>
                                
                                <!-- Add Value -->
                                <form method="POST" action="{{ url_for('dropdown_value_create') }}" class="mb-3 flex gap-2">
                                    <input type="hidden" name="category" value="{{ category }}">
                                    <input type="text" 
                                           name="value" 
                                           placeholder="Nov√° hodnota..."
                                           required
                                           class="flex-1 px-2.5 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-yellow-500">
                                    <button type="submit" 
                                            class="px-3 py-1.5 text-xs bg-[#FDB913] text-gray-900 font-medium rounded hover:bg-[#f0ad00] transition">
                                        +
                                    </button>
                                </form>
                                
                                <!-- Values -->
                                <div class="space-y-1.5 max-h-60 overflow-y-auto">
                                    {% for source in dropdown_sources[category] %}
                                    <div class="flex items-center gap-2 p-2 bg-gray-50 border border-gray-200 rounded text-sm">
                                        <span class="flex-1 text-gray-900">{{ source.value }}</span>
                                        <button onclick="if(confirm('Smazat?')) location.href='/settings/dropdown/value/{{ source.id }}/delete'"
                                                class="icon-btn text-red-600 hover:bg-red-50">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-12 text-gray-500">
                            <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <p class="font-medium mb-2">Zat√≠m ≈æ√°dn√© kategorie</p>
                            <p class="text-sm">Vytvo≈ôte prvn√≠ kategorii v√Ω≈°e</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Current state
let currentEntity = 'revision';
let currentTab = {};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Set entity counts
    {% for entity_type in ['revision', 'switchboard', 'device', 'circuit', 'terminal_device'] %}
    {% set count = field_configs | selectattr('entity_type', 'equalto', entity_type) | list | length %}
    document.getElementById('count-{{ entity_type }}').textContent = '{{ count }} pol√≠';
    {% endfor %}
    
    // Show first entity
    showEntity('revision');
});

// Show entity
function showEntity(entityType) {
    currentEntity = entityType;
    
    // Hide all panels
    document.querySelectorAll('.entity-panel').forEach(el => el.classList.add('hidden'));
    document.getElementById('dropdown-manager').classList.add('hidden');
    
    // Show selected panel
    document.getElementById(`entity-${entityType}`).classList.remove('hidden');
    
    // Update button styles
    document.querySelectorAll('.entity-btn').forEach(btn => {
        btn.classList.remove('bg-yellow-50', 'border-l-4', 'border-yellow-500');
    });
    document.getElementById(`btn-${entityType}`).classList.add('bg-yellow-50', 'border-l-4', 'border-yellow-500');
    
    // Show fields tab by default
    if (!currentTab[entityType]) {
        showTab(entityType, 'fields');
    }
}

// Show tab
function showTab(entityType, tabName) {
    currentTab[entityType] = tabName;
    
    // Update tabs
    document.querySelectorAll(`#entity-${entityType} .entity-tab`).forEach(tab => {
        tab.classList.remove('tab-active');
        tab.classList.add('tab-inactive');
    });
    document.getElementById(`tab-${entityType}-${tabName}`).classList.remove('tab-inactive');
    document.getElementById(`tab-${entityType}-${tabName}`).classList.add('tab-active');
    
    // Update content
    document.querySelectorAll(`#entity-${entityType} .tab-content`).forEach(content => {
        content.classList.add('hidden');
    });
    document.getElementById(`content-${entityType}-${tabName}`).classList.remove('hidden');
}

// Show dropdown manager
function showDropdownManager() {
    document.querySelectorAll('.entity-panel').forEach(el => el.classList.add('hidden'));
    document.getElementById('dropdown-manager').classList.remove('hidden');
    
    // Update button styles
    document.querySelectorAll('.entity-btn').forEach(btn => {
        btn.classList.remove('bg-yellow-50', 'border-l-4', 'border-yellow-500');
    });
}

// Toggle field visibility
async function toggleField(fieldId, enabled) {
    try {
        const formData = new FormData();
        formData.append('field_id', fieldId);
        formData.append('enabled', enabled);
        
        const response = await fetch('/settings/field/toggle', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            console.log('Field toggled:', fieldId, enabled);
        }
    } catch (error) {
        console.error('Error toggling field:', error);
    }
}

// Toggle dropdown category select
function toggleDropdownCategory(configKey) {
    const checkbox = document.getElementById(`dropdown_${configKey}`);
    const select = document.getElementById(`category_${configKey}`);
    select.disabled = !checkbox.checked;
}
</script>

{% endblock %}
