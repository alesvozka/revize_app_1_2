{% extends "base.html" %}

{% block title %}Nastaven√≠ - Revize App{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Page Header -->
    <div class="mb-6">
        <h2 class="text-2xl sm:text-3xl font-bold text-gray-900">Nastaven√≠</h2>
        <p class="text-sm text-gray-500 mt-2">Konfigurace aplikace a spr√°va formul√°≈ôov√Ωch pol√≠</p>
    </div>

    <!-- Card Layout -->
    <div class="space-y-4">
        
        <!-- üìã Dropdownov√© seznamy Card -->
        <div class="card bg-white border border-gray-200 rounded-lg overflow-hidden">
            <div class="card-header bg-gray-50 px-4 py-3 flex items-center justify-between border-b border-gray-200 cursor-pointer"
                 onclick="toggleCard('dropdowns')">
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                    </svg>
                    <div>
                        <h3 class="font-semibold text-gray-900">Dropdownov√© seznamy</h3>
                        <p class="text-xs text-gray-500 mt-0.5">Spr√°va kategori√≠ a hodnot pro dropdowny</p>
                    </div>
                </div>
                <svg id="icon-dropdowns" class="w-5 h-5 transform transition-transform text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
            <div id="content-dropdowns" class="hidden">
                <div class="p-4">
                    <!-- Add New Category -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <h4 class="text-sm font-semibold text-gray-900 mb-3">Nov√° kategorie</h4>
                        <form method="POST" action="{{ url_for('dropdown_category_create') }}" class="flex gap-3">
                            <input type="text" 
                                   name="category" 
                                   placeholder="nap≈ô. vyrobci_kabelu, typy_rozvadece"
                                   required
                                   class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <button type="submit" 
                                    class="bg-primary text-white px-5 py-2 rounded-lg hover:bg-blue-600 transition font-medium btn-flat whitespace-nowrap">
                                + P≈ôidat
                            </button>
                        </form>
                        <p class="text-xs text-gray-500 mt-2"><svg class="w-4 h-4 text-blue-600 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>Kategorie slou≈æ√≠ pro seskupen√≠ souvisej√≠c√≠ch hodnot</p>
                    </div>

                    <!-- Categories List -->
                    {% if categories %}
                    <div class="space-y-3">
                        {% for category in categories %}
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                            <!-- Category Header -->
                            <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 cursor-pointer hover:bg-gray-100 transition"
                                 onclick="toggleDropdown('category-{{ loop.index }}')">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                                        </svg>
                                        <h4 class="text-sm font-semibold text-gray-900">{{ category }}</h4>
                                        <span class="text-xs text-gray-500 bg-gray-200 px-2 py-0.5 rounded-full">
                                            {{ dropdown_sources[category]|length }} hodnot
                                        </span>
                                    </div>
                                    <svg id="icon-category-{{ loop.index }}" class="w-4 h-4 transform transition-transform text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                            </div>
                            
                            <!-- Category Content -->
                            <div id="content-category-{{ loop.index }}" class="hidden">
                                <div class="p-4">
                                    <!-- Add new value form -->
                                    <form method="POST" action="{{ url_for('dropdown_value_create') }}" class="mb-3 flex gap-2">
                                        <input type="hidden" name="category" value="{{ category }}">
                                        <input type="text" 
                                               name="value" 
                                               placeholder="Nov√° hodnota..."
                                               required
                                               class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <button type="submit" 
                                                class="px-4 py-2 text-sm bg-primary text-white font-medium rounded-lg hover:bg-blue-600 transition btn-flat whitespace-nowrap flex items-center gap-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                            </svg>
                                            P≈ôidat
                                        </button>
                                    </form>

                                    <!-- Values list -->
                                    <div class="space-y-1.5 max-h-60 overflow-y-auto">
                                        {% for source in dropdown_sources[category] %}
                                        <div class="flex items-center gap-2 p-2 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition group">
                                            <!-- Move buttons -->
                                            <div class="flex flex-col gap-0.5">
                                                <button onclick="location.href='/settings/dropdown/value/{{ source.id }}/move-up'" 
                                                        class="text-gray-400 hover:text-primary transition p-0.5 opacity-0 group-hover:opacity-100"
                                                        title="Posunout nahoru">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 15l7-7 7 7"></path>
                                            </svg>
                                        </button>
                                                <button onclick="location.href='/settings/dropdown/value/{{ source.id }}/move-down'" 
                                                        class="text-gray-400 hover:text-primary transition p-0.5 opacity-0 group-hover:opacity-100"
                                                        title="Posunout dol≈Ø">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </button>
                                    </div>
                                    
                                    <!-- Value text -->
                                    <span class="flex-1 text-sm text-gray-900">{{ source.value }}</span>
                                    
                                            <!-- Delete button -->
                                            <button onclick="if(confirm('Smazat tuto hodnotu?')) location.href='/settings/dropdown/value/{{ source.id }}/delete'" 
                                                    class="text-red-500 hover:text-red-700 transition p-1 opacity-0 group-hover:opacity-100"
                                                    title="Smazat">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-8 text-center">
                        <svg class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p class="text-gray-500 text-sm font-medium mb-1">Zat√≠m nejsou vytvo≈ôeny ≈æ√°dn√© kategorie</p>
                        <p class="text-gray-400 text-xs">Zaƒçnƒõte p≈ôid√°n√≠m nov√© kategorie v√Ω≈°e</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ‚öôÔ∏è Konfigurace dropdown≈Ø Card -->
        <div class="card bg-white border border-gray-200 rounded-lg overflow-hidden">
            <div class="card-header bg-gray-50 px-4 py-3 flex items-center justify-between border-b border-gray-200 cursor-pointer"
                 onclick="toggleCard('config')">
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <div>
                        <h3 class="font-semibold text-gray-900">Konfigurace dropdown≈Ø pro pole</h3>
                        <p class="text-xs text-gray-500 mt-0.5">P≈ôi≈ôaƒète dropdown kategorie k pol√≠m</p>
                    </div>
                </div>
                <svg id="icon-config" class="w-5 h-5 transform transition-transform text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
            <div id="content-config" class="hidden">
                <div class="p-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                        <p class="text-sm text-blue-800">
                            <strong><svg class="w-4 h-4 text-blue-600 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg><strong>Tip:</strong></strong> Za≈°krtnƒõte pole, vyberte dropdown kategorii (nap≈ô. "vyrobci_kabelu") a ulo≈æte. Pole pak bude m√≠t dropdown s hodnotami z t√©to kategorie.
                        </p>
                    </div>
                    
                    <!-- Configuration by Entity -->
                    {% for entity_type, fields in configurable_fields.items() %}
                    <div class="mb-6 {% if not loop.last %}pb-6 border-b border-gray-200{% endif %}">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                            {% if entity_type == 'switchboard' %}<svg class="w-4 h-4 text-primary inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                </svg>Rozv√°dƒõƒç
                            {% elif entity_type == 'device' %}<svg class="w-4 h-4 text-primary inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                                </svg>P≈ô√≠stroj
                            {% elif entity_type == 'circuit' %}<svg class="w-4 h-4 text-primary inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>Obvod
                            {% elif entity_type == 'terminal_device' %}<svg class="w-4 h-4 text-primary inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                </svg>Koncov√© za≈ô√≠zen√≠
                            {% elif entity_type == 'revision' %}<svg class="w-4 h-4 text-primary inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>Revize
                            {% endif %}
                        </h4>
                        
                        <div class="space-y-2">
                            {% for field_name, field_label in fields.items() %}
                            {% set config_key = entity_type ~ '_' ~ field_name %}
                            {% set config = configs_dict.get(config_key) %}
                            
                            <form method="POST" action="{{ url_for('dropdown_config_update') }}" 
                                  class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50 transition-colors">
                                <input type="hidden" name="entity_type" value="{{ entity_type }}">
                                <input type="hidden" name="field_name" value="{{ field_name }}">
                                
                                <div class="flex items-center gap-3">
                                    <!-- Enable/Disable Checkbox -->
                                    <div class="flex items-center">
                                        <input type="checkbox" 
                                               name="dropdown_enabled" 
                                               id="enable_{{ config_key }}"
                                               onchange="toggleDropdownConfig('{{ config_key }}')"
                                               {% if config and config.dropdown_enabled %}checked{% endif %}
                                               class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
                                    </div>
                                    
                                    <!-- Field Info -->
                                    <div class="flex-1 min-w-0">
                                        <label for="enable_{{ config_key }}" class="block text-sm font-medium text-gray-700 cursor-pointer truncate">
                                            {{ field_label }}
                                        </label>
                                        <p class="text-xs text-gray-500 truncate"><code class="bg-gray-100 px-1 rounded">{{ field_name }}</code></p>
                                    </div>
                                    
                                    <!-- Category Selection -->
                                    <div class="flex-1">
                                        <select name="dropdown_category" 
                                                id="category_{{ config_key }}"
                                                {% if not config or not config.dropdown_enabled %}disabled{% endif %}
                                                class="w-full px-2.5 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent disabled:bg-gray-100 disabled:text-gray-400">
                                            <option value="">-- Vyberte kategorii --</option>
                                            {% for category in categories %}
                                            <option value="{{ category }}" 
                                                    {% if config and config.dropdown_category == category %}selected{% endif %}>
                                                {{ category }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <!-- Save Button -->
                                    <button type="submit" 
                                            class="px-4 py-1.5 bg-primary text-white text-sm font-medium rounded-lg hover:bg-blue-600 transition whitespace-nowrap btn-flat">
                                        üíæ Ulo≈æit
                                    </button>
                                </div>
                            </form>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- üëÅÔ∏è Viditelnost pol√≠ Card -->
        <div class="card bg-white border border-gray-200 rounded-lg overflow-hidden">
            <div class="card-header bg-gray-50 px-4 py-3 flex items-center justify-between border-b border-gray-200 cursor-pointer"
                 onclick="toggleCard('visibility')">
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    <div>
                        <h3 class="font-semibold text-gray-900">Viditelnost pol√≠</h3>
                        <p class="text-xs text-gray-500 mt-0.5">Zapnƒõte/vypnƒõte pole podle va≈°eho workflow</p>
                    </div>
                </div>
                <svg id="icon-visibility" class="w-5 h-5 transform transition-transform text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
            <div id="content-visibility" class="hidden">
                <div class="p-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                        <p class="text-sm text-blue-800">
                            <strong>üí° Jak to funguje:</strong> Vypnut√° pole se nezobraz√≠ ve formul√°≈ô√≠ch. Povinn√° pole nelze vypnout.
                        </p>
                    </div>

                    <!-- Entity Type Selector -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Vyberte entitu:</label>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="showFieldConfig('revision')" 
                                    id="entity-btn-revision"
                                    class="entity-btn px-4 py-2 text-sm font-medium border rounded-lg transition">
                                <svg class="w-4 h-4 text-primary inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>Revize
                            </button>
                            <button onclick="showFieldConfig('switchboard')" 
                                    id="entity-btn-switchboard"
                                    class="entity-btn px-4 py-2 text-sm font-medium border rounded-lg transition">
                                <svg class="w-4 h-4 text-primary inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                </svg>Rozv√°dƒõƒç
                            </button>
                            <button onclick="showFieldConfig('device')" 
                                    id="entity-btn-device"
                                    class="entity-btn px-4 py-2 text-sm font-medium border rounded-lg transition">
                                <svg class="w-4 h-4 text-primary inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                                </svg>P≈ô√≠stroj
                            </button>
                            <button onclick="showFieldConfig('circuit')" 
                                    id="entity-btn-circuit"
                                    class="entity-btn px-4 py-2 text-sm font-medium border rounded-lg transition">
                                <svg class="w-4 h-4 text-primary inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>Obvod
                            </button>
                            <button onclick="showFieldConfig('terminal_device')" 
                                    id="entity-btn-terminal_device"
                                    class="entity-btn px-4 py-2 text-sm font-medium border rounded-lg transition">
                                <svg class="w-4 h-4 text-primary inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                </svg>Koncov√© za≈ô√≠zen√≠
                            </button>
                        </div>
                    </div>

                    <!-- Field Configuration Panels -->
                    {% for entity_type in ['revision', 'switchboard', 'device', 'circuit', 'terminal_device'] %}
                    <div id="field-config-{{ entity_type }}" class="field-config-panel hidden">
                        {% set entity_fields = field_configs | selectattr('entity_type', 'equalto', entity_type) | list %}
                        
                        {% if entity_fields %}
                        <!-- Group by category -->
                        {% for category in ['basic', 'additional', 'technical', 'administrative', 'measurements'] %}
                            {% set cat_fields = entity_fields | selectattr('category', 'equalto', category) | list %}
                            {% if cat_fields %}
                            <div class="mb-6">
                                <h5 class="text-sm font-semibold text-gray-700 mb-3">
                                    {% if category == 'basic' %}<svg class="w-4 h-4 text-blue-600 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>Z√°kladn√≠ pole
                                    {% elif category == 'additional' %}<svg class="w-4 h-4 text-purple-600 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                                    </svg>Dodateƒçn√© pole
                                    {% elif category == 'technical' %}<svg class="w-4 h-4 text-orange-600 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>Technick√© pole
                                    {% elif category == 'administrative' %}<svg class="w-4 h-4 text-green-600 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>Administrativn√≠ pole
                                    {% elif category == 'measurements' %}<svg class="w-4 h-4 text-red-600 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>Mƒõ≈ôen√≠
                                    {% endif %}
                                    <span class="text-xs text-gray-500 ml-1">({{ cat_fields | length }})</span>
                                </h5>
                                
                                <div class="space-y-2 drop-zone" 
                                     data-category="{{ category }}"
                                     ondrop="dropField(event)" 
                                     ondragover="allowDrop(event)"
                                     ondragenter="handleDragEnter(event)"
                                     ondragleave="handleDragLeave(event)">
                                    {% for field in cat_fields %}
                                    <div class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 hover:bg-gray-50 transition cursor-move"
                                         draggable="true"
                                         data-field-id="{{ field.id }}"
                                         data-field-category="{{ category }}"
                                         ondragstart="dragStart(event)"
                                         ondragend="dragEnd(event)">
                                        <!-- Drag handle icon -->
                                        <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                                        </svg>
                                        
                                        <!-- Toggle -->
                                        <input type="checkbox"
                                               {% if field.enabled %}checked{% endif %}
                                               {% if field.required %}disabled{% endif %}
                                               onchange="toggleField('{{ field.id }}', this.checked)"
                                               onclick="event.stopPropagation()"
                                               class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary {% if field.required %}opacity-50 cursor-not-allowed{% endif %}">
                                        
                                        <!-- Field Info -->
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm font-medium text-gray-900">{{ field.label }}</span>
                                                {% if field.required %}
                                                <span class="px-2 py-0.5 text-xs font-medium rounded bg-red-100 text-red-700">
                                                    Povinn√©
                                                </span>
                                                {% endif %}
                                                {% if field.dropdown_enabled %}
                                                <span class="px-2 py-0.5 text-xs font-medium rounded bg-blue-100 text-blue-700">
                                                    Dropdown
                                                </span>
                                                {% endif %}
                                            </div>
                                            <p class="text-xs text-gray-500 font-mono">{{ field.name }}</p>
                                        </div>
                                        
                                        <!-- Status indicator -->
                                        <div class="text-sm">
                                            {% if field.enabled %}
                                            <span class="inline-flex w-2 h-2 rounded-full bg-green-500"></span>
                                            {% else %}
                                            <span class="inline-flex w-2 h-2 rounded-full bg-gray-300"></span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                        {% else %}
                        <div class="text-center py-8 text-gray-500">
                            <p>≈Ω√°dn√° pole k dispozici</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

    </div>
</div>

<script>
// Toggle card visibility
function toggleCard(cardId) {
    const content = document.getElementById('content-' + cardId);
    const icon = document.getElementById('icon-' + cardId);
    
    content.classList.toggle('hidden');
    icon.classList.toggle('rotate-180');
}

// Toggle dropdown category visibility (NEW - for collapsible categories)
function toggleDropdown(dropdownId) {
    const content = document.getElementById('content-' + dropdownId);
    const icon = document.getElementById('icon-' + dropdownId);
    
    content.classList.toggle('hidden');
    icon.classList.toggle('rotate-180');
}

// Toggle dropdown category select enable/disable
function toggleDropdownConfig(configKey) {
    const checkbox = document.getElementById(`enable_${configKey}`);
    const select = document.getElementById(`category_${configKey}`);
    select.disabled = !checkbox.checked;
    
    // üîß BUGFIX: Auto-select first category when enabling dropdown
    if (checkbox.checked && (!select.value || select.value === '')) {
        // Find first non-empty option
        for (let i = 0; i < select.options.length; i++) {
            if (select.options[i].value !== '') {
                select.value = select.options[i].value;
                break;
            }
        }
    }
}

// Show field configuration for entity
function showFieldConfig(entityType) {
    // Hide all panels
    document.querySelectorAll('.field-config-panel').forEach(panel => {
        panel.classList.add('hidden');
    });
    
    // Show selected panel
    document.getElementById(`field-config-${entityType}`).classList.remove('hidden');
    
    // Update button styles
    document.querySelectorAll('.entity-btn').forEach(btn => {
        btn.classList.remove('bg-primary', 'text-white', 'border-primary');
        btn.classList.add('border-gray-300', 'hover:bg-gray-50');
    });
    
    const selectedBtn = document.getElementById(`entity-btn-${entityType}`);
    selectedBtn.classList.remove('border-gray-300', 'hover:bg-gray-50');
    selectedBtn.classList.add('bg-primary', 'text-white', 'border-primary');
}

// Toggle field visibility via AJAX
async function toggleField(fieldId, enabled) {
    try {
        const formData = new FormData();
        formData.append('field_id', fieldId);
        formData.append('enabled', enabled);
        
        const response = await fetch('/settings/field/toggle', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            console.log('Field toggled:', fieldId, enabled);
        }
    } catch (error) {
        console.error('Error toggling field:', error);
    }
}

// Drag & Drop functions for field reordering
let draggedElement = null;

function dragStart(e) {
    draggedElement = e.target;
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', e.target.innerHTML);
    e.target.style.opacity = '0.5';
    e.target.classList.add('border-primary');
}

function dragEnd(e) {
    // Reset styles if drag was cancelled
    if (draggedElement) {
        draggedElement.style.opacity = '1';
        draggedElement.classList.remove('border-primary');
    }
    
    // Remove all drop zone highlights
    document.querySelectorAll('.drop-zone').forEach(zone => {
        zone.classList.remove('bg-blue-50', 'border-2', 'border-blue-400', 'border-dashed');
    });
}

function allowDrop(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
}

function handleDragEnter(e) {
    const dropZone = e.target.closest('.drop-zone');
    if (dropZone && draggedElement) {
        dropZone.classList.add('bg-blue-50', 'border-2', 'border-blue-400', 'border-dashed');
    }
}

function handleDragLeave(e) {
    const dropZone = e.target.closest('.drop-zone');
    if (dropZone) {
        dropZone.classList.remove('bg-blue-50', 'border-2', 'border-blue-400', 'border-dashed');
    }
}

async function dropField(e) {
    e.preventDefault();
    e.stopPropagation();
    
    if (!draggedElement) return;
    
    const dropZone = e.target.closest('.drop-zone');
    if (!dropZone) return;
    
    // Remove highlight
    dropZone.classList.remove('bg-blue-50', 'border-2', 'border-blue-400', 'border-dashed');
    
    const fieldId = draggedElement.getAttribute('data-field-id');
    const oldCategory = draggedElement.getAttribute('data-field-category');
    const newCategory = dropZone.getAttribute('data-category');
    
    // Reset opacity and border
    draggedElement.style.opacity = '1';
    draggedElement.classList.remove('border-primary');
    
    // Don't do anything if dropped in same category
    if (oldCategory === newCategory) {
        return;
    }
    
    // Update via AJAX
    try {
        const formData = new FormData();
        formData.append('category', newCategory);
        
        const response = await fetch(`/settings/field-config/${fieldId}/change-category`, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            // Move the element visually
            draggedElement.setAttribute('data-field-category', newCategory);
            dropZone.appendChild(draggedElement);
            
            // Update counts
            updateCategoryCounts();
            
            // Show success message briefly
            const fieldLabel = draggedElement.querySelector('.text-sm').textContent;
            console.log(`‚úì Pole "${fieldLabel}" p≈ôesunuto do kategorie "${getCategoryLabel(newCategory)}"`);
        } else {
            alert('Nepoda≈ôilo se p≈ôesunout pole. Zkuste to znovu.');
        }
    } catch (error) {
        console.error('Error moving field:', error);
        alert('Chyba p≈ôi p≈ôesouv√°n√≠ pole.');
    }
    
    draggedElement = null;
}

function getCategoryLabel(category) {
    const labels = {
        'basic': 'Z√°kladn√≠ pole',
        'additional': 'Dodateƒçn√© pole',
        'technical': 'Technick√© pole',
        'administrative': 'Administrativn√≠ pole',
        'measurements': 'Mƒõ≈ôen√≠'
    };
    return labels[category] || category;
}

function updateCategoryCounts() {
    // Update category counts after drag & drop
    document.querySelectorAll('.drop-zone').forEach(zone => {
        const category = zone.getAttribute('data-category');
        const count = zone.querySelectorAll('[data-field-id]').length;
        const header = zone.previousElementSibling;
        if (header) {
            const countSpan = header.querySelector('.text-xs');
            if (countSpan) {
                countSpan.textContent = `(${count})`;
            }
        }
    });
}

// Initialize - show first entity
document.addEventListener('DOMContentLoaded', function() {
    showFieldConfig('revision');
});
</script>

{% endblock %}
