{% extends "base.html" %}
{% block title %}Rozvaděč – detail{% endblock %}
{% block content %}
<a href="/revisions/{{ revision.revision_id }}" class="btn btn-link mb-2">&larr; Zpět na revizi</a>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h4 mb-0">{{ switchboard.switchboard_name }}</h1>
    <div class="text-muted">
      {% if switchboard.switchboard_location %}
        <span class="me-2">Místo: {{ switchboard.switchboard_location }}</span>
      {% endif %}
      {% if switchboard.switchboard_type %}
        <span class="me-2">Typ: {{ switchboard.switchboard_type }}</span>
      {% endif %}
      {% if switchboard.switchboard_serial_number %}
        <span>Výrobní číslo: {{ switchboard.switchboard_serial_number }}</span>
      {% endif %}
    </div>
  </div>
  <form action="/switchboards/{{ switchboard.switchboard_id }}/delete" method="post" onsubmit="return confirm('Opravdu smazat rozvaděč?');">
    <button type="submit" class="btn btn-outline-danger btn-sm">Smazat</button>
  </form>
</div>

<div class="card mb-4">
  <div class="card-header">
    Údaje o rozvaděči
  </div>
  <div class="card-body">
    <form action="/switchboards/{{ switchboard.switchboard_id }}/edit" method="post" class="row g-2">
      <div class="col-md-4">
        <label class="form-label">Název</label>
        <input type="text" name="switchboard_name" class="form-control" value="{{ switchboard.switchboard_name }}">
      </div>
      <div class="col-md-4">
        <label class="form-label">Umístění</label>
        <input type="text" name="switchboard_location" class="form-control" value="{{ switchboard.switchboard_location or '' }}">
      </div>
      <div class="col-md-4">
        <label class="form-label">Poznámka</label>
        <input type="text" name="switchboard_note" class="form-control" value="{{ switchboard.switchboard_note or '' }}">
      </div>
      <div class="col-12 mt-2">
        <button type="submit" class="btn btn-primary btn-sm">Uložit údaje rozvaděče</button>
      </div>
    </form>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header">
    Měření rozvaděče
  </div>
  <div class="card-body">
    <form action="/switchboards/{{ switchboard.switchboard_id }}/measurements/save" method="post" class="row g-2">
      <div class="col-md-4">
        <label class="form-label">Riz izolace [MΩ]</label>
        <input type="number" step="0.01" name="measurements_switchboard_insulation_resistance"
               class="form-control"
               value="{{ measurement.measurements_switchboard_insulation_resistance if measurement else '' }}">
      </div>
      <div class="col-md-4">
        <label class="form-label">Zs min [Ω]</label>
        <input type="number" step="0.001" name="measurements_switchboard_loop_impedance_min"
               class="form-control"
               value="{{ measurement.measurements_switchboard_loop_impedance_min if measurement else '' }}">
      </div>
      <div class="col-md-4">
        <label class="form-label">Zs max [Ω]</label>
        <input type="number" step="0.001" name="measurements_switchboard_loop_impedance_max"
               class="form-control"
               value="{{ measurement.measurements_switchboard_loop_impedance_max if measurement else '' }}">
      </div>
      <div class="col-md-4">
        <label class="form-label">tΔ [ms]</label>
        <input type="number" step="0.1" name="measurements_switchboard_rcd_trip_time_ms"
               class="form-control"
               value="{{ measurement.measurements_switchboard_rcd_trip_time_ms if measurement else '' }}">
      </div>
      <div class="col-md-4">
        <label class="form-label">IΔ [mA]</label>
        <input type="number" step="0.1" name="measurements_switchboard_rcd_test_current_ma"
               class="form-control"
               value="{{ measurement.measurements_switchboard_rcd_test_current_ma if measurement else '' }}">
      </div>
      <div class="col-md-4">
        <label class="form-label">Rz [Ω]</label>
        <input type="number" step="0.1" name="measurements_switchboard_earth_resistance"
               class="form-control"
               value="{{ measurement.measurements_switchboard_earth_resistance if measurement else '' }}">
      </div>
      <div class="col-12 mt-2">
        <button type="submit" class="btn btn-primary btn-sm">Uložit měření rozvaděče</button>
      </div>
    </form>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Přístroje v rozvaděči</span>
    <span class="small text-muted">Jističe, chrániče, kombinované přístroje…</span>
  </div>
  <div class="card-body">
    <form action="/switchboards/{{ switchboard.switchboard_id }}/devices/create" method="post" class="border rounded p-3 mb-3 bg-light">
      <div class="row g-2">
        <div class="col-md-2">
          <label class="form-label">Pozice</label>
          <input type="text" name="switchboard_device_position" class="form-control form-control-sm" placeholder="např. 1L">
        </div>
        <div class="col-md-2">
          <label class="form-label">Typ</label>
          <input type="text" name="switchboard_device_type" class="form-control form-control-sm" placeholder="MCB/RCD/RCBO">
        </div>
        <div class="col-md-3">
          <label class="form-label">Výrobce</label>
          <input type="text" name="switchboard_device_manufacturer" class="form-control form-control-sm">
        </div>
        <div class="col-md-3">
          <label class="form-label">Model</label>
          <input type="text" name="switchboard_device_model" class="form-control form-control-sm">
        </div>
        <div class="col-md-2">
          <label class="form-label">Charakteristika</label>
          <input type="text" name="switchboard_device_trip_characteristic" class="form-control form-control-sm" placeholder="B/C/D">
        </div>
      </div>
      <div class="row g-2 mt-1">
        <div class="col-md-2">
          <label class="form-label">In [A]</label>
          <input type="number" step="1" name="switchboard_device_rated_current" class="form-control form-control-sm">
        </div>
        <div class="col-md-2">
          <label class="form-label">IΔn [mA]</label>
          <input type="number" step="1" name="switchboard_device_residual_current_ma" class="form-control form-control-sm">
        </div>
        <div class="col-md-2">
          <label class="form-label">Póly</label>
          <input type="number" step="1" name="switchboard_device_poles" class="form-control form-control-sm">
        </div>
        <div class="col-md-2">
          <label class="form-label">Moduly</label>
          <input type="number" step="0.5" name="switchboard_device_module_width" class="form-control form-control-sm">
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button type="submit" class="btn btn-primary btn-sm w-100">Přidat přístroj</button>
        </div>
      </div>
    </form>

    {% if devices %}
      <div class="table-responsive">
        <table class="table table-sm align-middle table-bordered bg-white">
          <thead class="table-light">
            <tr>
              <th>Pozice</th>
              <th>Typ</th>
              <th>Popis</th>
              <th>In / IΔn / pólů</th>
              <th>Obvody</th>
              <th style="width: 6rem;">Akce</th>
            </tr>
          </thead>
          <tbody>
            {% for dev in devices %}
              <tr>
                <td>{{ dev.switchboard_device_position }}</td>
                <td>
                  {{ dev.switchboard_device_type }}
                  {% if dev.switchboard_device_manufacturer or dev.switchboard_device_model %}
                    <div class="small text-muted">
                      {{ dev.switchboard_device_manufacturer }} {{ dev.switchboard_device_model }}
                    </div>
                  {% endif %}
                </td>
                <td>
                  {% if dev.switchboard_device_trip_characteristic %}
                    Char: {{ dev.switchboard_device_trip_characteristic }}
                  {% endif %}
                </td>
                <td>
                  <div class="small">
                    In: {{ dev.switchboard_device_rated_current or "-" }} A<br>
                    IΔn: {{ dev.switchboard_device_residual_current_ma or "-" }} mA<br>
                    Póly: {{ dev.switchboard_device_poles or "-" }} / Moduly: {{ dev.switchboard_device_module_width or "-" }}
                  </div>
                </td>
                <td>
                  {% if dev.circuits %}
                    {% for c in dev.circuits %}
                      <div class="border rounded p-2 mb-2">
                        <div class="d-flex justify-content_between">
                          <div>
                            <strong>{{ c.circuit_number or "Obvod" }}</strong>
                            {% if c.circuit_room %}
                              <span class="small text-muted">({{ c.circuit_room }})</span>
                            {% endif %}
                            {% if c.circuit_description %}
                              <div class="small">{{ c.circuit_description }}</div>
                            {% endif %}
                            {% if c.circuit_cable %}
                              <div class="small text-muted">
                                Kabel: {{ c.circuit_cable }} ({{ c.circuit_cable_installation_method or "" }})
                              </div>
                            {% endif %}
                          </div>
                          <form action="/circuits/{{ c.circuit_id }}/delete" method="post" onsubmit="return confirm('Smazat obvod?');">
                            <button type="submit" class="btn btn-outline-danger btn-sm">×</button>
                          </form>
                        </div>

                        <form action="/circuits/{{ c.circuit_id }}/measurements/save" method="post" class="mt-2">
                          <div class="row g-1">
                            <div class="col-4">
                              <input type="number" step="0.01" name="measurements_circuit_insulation_resistance"
                                     class="form-control form-control-sm"
                                     placeholder="Riz [MΩ]"
                                     value="{{ c.measurements.measurements_circuit_insulation_resistance if c.measurements else '' }}">
                            </div>
                            <div class="col-4">
                              <input type="number" step="0.001" name="measurements_circuit_loop_impedance_min"
                                     class="form-control form-control-sm"
                                     placeholder="Zs min [Ω]"
                                     value="{{ c.measurements.measurements_circuit_loop_impedance_min if c.measurements else '' }}">
                            </div>
                            <div class="col-4">
                              <input type="number" step="0.001" name="measurements_circuit_loop_impedance_max"
                                     class="form-control form-control-sm"
                                     placeholder="Zs max [Ω]"
                                     value="{{ c.measurements.measurements_circuit_loop_impedance_max if c.measurements else '' }}">
                            </div>
                          </div>
                          <div class="row g-1 mt-1">
                            <div class="col-4">
                              <input type="number" step="0.1" name="measurements_circuit_rcd_trip_time_ms"
                                     class="form-control form-control-sm"
                                     placeholder="tΔ [ms]"
                                     value="{{ c.measurements.measurements_circuit_rcd_trip_time_ms if c.measurements else '' }}">
                            </div>
                            <div class="col-4">
                              <input type="number" step="0.1" name="measurements_circuit_rcd_test_current_ma"
                                     class="form-control form-control-sm"
                                     placeholder="IΔ [mA]"
                                     value="{{ c.measurements.measurements_circuit_rcd_test_current_ma if c.measurements else '' }}">
                            </div>
                            <div class="col-4">
                              <input type="number" step="0.1" name="measurements_circuit_earth_resistance"
                                     class="form-control form-control-sm"
                                     placeholder="Rz [Ω]"
                                     value="{{ c.measurements.measurements_circuit_earth_resistance if c.measurements else '' }}">
                            </div>
                          </div>
                          <div class="row g-1 mt-1">
                            <div class="col-4">
                              <input type="number" step="0.1" name="measurements_circuit_continuity"
                                     class="form-control form-control-sm"
                                     placeholder="R smyčky [Ω]"
                                     value="{{ c.measurements.measurements_circuit_continuity if c.measurements else '' }}">
                            </div>
                            <div class="col-8">
                              <input type="text" name="measurements_circuit_order_of_phases"
                                     class="form-control form-control-sm"
                                     placeholder="Pořadí fází"
                                     value="{{ c.measurements.measurements_circuit_order_of_phases if c.measurements else '' }}">
                            </div>
                          </div>
                          <button type="submit" class="btn btn-outline-primary btn-sm mt-1">Uložit měření obvodu</button>
                        </form>

                        <hr class="my-2">

                        <div class="small fw-semibold mb-1">Koncová zařízení</div>
                        {% if c.terminal_devices %}
                          <ul class="small mb-2">
                            {% for td in c.terminal_devices %}
                              <li>
                                {{ td.terminal_device_type or "Zařízení" }}
                                {% if td.terminal_device_marking %}
                                  – {{ td.terminal_device_marking }}
                                {% endif %}
                                {% if td.terminal_device_power %}
                                  ({{ td.terminal_device_power }} W)
                                {% endif %}
                                <form action="/terminal-devices/{{ td.terminal_device_id }}/delete"
                                      method="post" class="d-inline"
                                      onsubmit="return confirm('Smazat zařízení?');">
                                  <button type="submit" class="btn btn-link btn-sm text-danger p-0 ms-1">smazat</button>
                                </form>
                              </li>
                            {% endfor %}
                          </ul>
                        {% else %}
                          <div class="small text-muted">Žádná koncová zařízení.</div>
                        {% endif %}

                        <form action="/circuits/{{ c.circuit_id }}/terminal-devices/create" method="post" class="mt-1">
                          <div class="row g-1">
                            <div class="col-4">
                              <input type="text" name="terminal_device_type" class="form-control form-control-sm" placeholder="Typ">
                            </div>
                            <div class="col-4">
                              <input type="text" name="terminal_device_marking" class="form-control form-control-sm" placeholder="Označení">
                            </div>
                            <div class="col-4">
                              <input type="number" step="1" name="terminal_device_power" class="form-control form-control-sm" placeholder="Výkon [W]">
                            </div>
                          </div>
                          <div class="row g-1 mt-1">
                            <div class="col-4">
                              <input type="text" name="terminal_device_manufacturer" class="form-control form-control-sm" placeholder="Výrobce">
                            </div>
                            <div class="col-4">
                              <input type="text" name="terminal_device_model" class="form-control form-control-sm" placeholder="Model">
                            </div>
                            <div class="col-4">
                              <input type="text" name="terminal_device_ip_rating" class="form-control form-control-sm" placeholder="IP">
                            </div>
                          </div>
                          <div class="row g-1 mt-1">
                            <div class="col-4">
                              <input type="text" name="terminal_device_protection_class" class="form-control form-control-sm" placeholder="Třída ochr.">
                            </div>
                            <div class="col-4">
                              <input type="text" name="terminal_device_supply_type" class="form-control form-control-sm" placeholder="Napájení">
                            </div>
                            <div class="col-4">
                              <input type="text" name="terminal_device_installation_method" class="form-control form-control-sm" placeholder="Instalace">
                            </div>
                          </div>
                          <button type="submit" class="btn btn-outline-primary btn-sm mt-1">+ Zařízení</button>
                        </form>

                      </div>
                    {% endfor %}
                  {% else %}
                    <div class="small text-muted mb-1">Žádné obvody.</div>
                  {% endif %}

                  <form action="/devices/{{ dev.device_id }}/circuits/create" method="post" class="mt-1">
                    <div class="row g-1">
                      <div class="col-3">
                        <input type="text" name="circuit_number" class="form-control form-control-sm" placeholder="Č. obvodu">
                      </div>
                      <div class="col-3">
                        <input type="text" name="circuit_room" class="form-control form-control-sm" placeholder="Místnost">
                      </div>
                      <div class="col-3">
                        <input type="text" name="circuit_cable" class="form-control form-control-sm" placeholder="Kabel (např. CYKY)">
                      </div>
                      <div class="col-3">
                        <input type="number" step="1" name="circuit_number_of_outlets" class="form-control form-control-sm" placeholder="Zásuvky/ks">
                      </div>
                    </div>
                    <div class="row g-1 mt-1">
                      <div class="col-9">
                        <input type="text" name="circuit_description" class="form-control form-control-sm" placeholder="Popis obvodu">
                      </div>
                      <div class="col-3">
                        <button type="submit" class="btn btn-outline-primary btn-sm w-100">+ Obvod</button>
                      </div>
                    </div>
                  </form>
                </td>
                <td>
                  <form action="/devices/{{ dev.device_id }}/delete" method="post" onsubmit="return confirm('Smazat přístroj a všechny obvody?');">
                    <button type="submit" class="btn btn-sm btn-danger">Smazat</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">Zatím žádné přístroje.</div>
    {% endif %}
  </div>
</div>

{% endblock %}
