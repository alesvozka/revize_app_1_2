{% extends "base.html" %}
{% block title %}Rozvaděč – detail{% endblock %}
{% block content %}
<a href="/revisions/{{ revision.id }}" class="btn btn-link mb-2">&larr; Zpět na revizi</a>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h4 mb-0">{{ switchboard.name }}</h1>
    <div class="text-muted">
      {% if switchboard.code %}<span class="me-2">Kód: {{ switchboard.code }}</span>{% endif %}
      {% if switchboard.location %}<span>Místo: {{ switchboard.location }}</span>{% endif %}
    </div>
  </div>
  <form action="/switchboards/{{ switchboard.id }}/delete" method="post" onsubmit="return confirm('Opravdu smazat rozvaděč?');">
    <button type="submit" class="btn btn-outline-danger btn-sm">Smazat</button>
  </form>
</div>

{% if switchboard.note %}
  <p>{{ switchboard.note }}</p>
{% endif %}

<hr class="my-4">

<h2 class="h5 mb-3">Přístroje</h2>

<form action="/switchboards/{{ switchboard.id }}/devices/create" method="post" class="border rounded p-3 mb-4 bg-white">
  <div class="row g-2">
    <div class="col-md-2">
      <label class="form-label">Štítek</label>
      <input type="text" name="label" class="form-control" placeholder="Č. jističe">
    </div>
    <div class="col-md-3">
      <label class="form-label">Popis</label>
      <input type="text" name="description" class="form-control" placeholder="Název obvodu">
    </div>
    <div class="col-md-2">
      <label class="form-label">Typ</label>
      <select name="breaker_type" class="form-select">
        <option value="MCB">MCB – jistič</option>
        <option value="RCD">RCD – chránič</option>
        <option value="RCBO">RCBO – chráničojistič</option>
      </select>
    </div>
    <div class="col-md-1">
      <label class="form-label">Char</label>
      <select name="characteristic" class="form-select">
        <option value="B">B</option>
        <option value="C">C</option>
        <option value="D">D</option>
      </select>
    </div>
    <div class="col-md-1">
      <label class="form-label">In [A]</label>
      <input type="number" name="rated_current" class="form-control" value="16">
    </div>
    <div class="col-md-1">
      <label class="form-label">Póly</label>
      <input type="number" name="poles" class="form-control" value="1">
    </div>
    <div class="col-md-2">
      <label class="form-label">IΔn [mA]</label>
      <input type="number" name="rcd_sensitivity" class="form-control">
    </div>
  </div>
  <div class="mt-2">
    <label class="form-label">Poznámka</label>
    <input type="text" name="note" class="form-control">
  </div>
  <button type="submit" class="btn btn-primary mt-3">Přidat přístroj</button>
</form>

{% if switchboard.devices %}
  <div class="table-responsive">
    <table class="table table-sm align-middle table-bordered bg-white">
      <thead class="table-light">
        <tr>
          <th style="width: 4rem;">Řádek</th>
          <th>Štítek</th>
          <th>Popis</th>
          <th>Typ</th>
          <th>Char</th>
          <th>In [A]</th>
          <th>Póly</th>
          <th>IΔn [mA]</th>
          <th>Obvody</th>
          <th style="width: 8rem;">Akce</th>
        </tr>
      </thead>
      <tbody>
        {% for dev in switchboard.devices %}
          <tr>
            <td>{{ dev.row_order }}</td>
            <td>{{ dev.label }}</td>
            <td>{{ dev.description }}</td>
            <td>{{ dev.breaker_type }}</td>
            <td>{{ dev.characteristic }}</td>
            <td>{{ dev.rated_current }}</td>
            <td>{{ dev.poles }}</td>
            <td>{{ dev.rcd_sensitivity or "" }}</td>
            <td>
              {% if dev.circuits %}
                <ul class="mb-1">
                  {% for c in dev.circuits %}
                    <li>
                      {{ c.room or "?" }} – {{ c.usage or "" }}
                      {% if c.cable_type or c.cable_size %}
                        <span class="text-muted small">
                          ({{ c.cable_type }} {{ c.cable_size }})
                        </span>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <span class="text-muted small">Žádné obvody</span>
              {% endif %}

              <form action="/devices/{{ dev.id }}/circuits/create" method="post" class="mt-2">
                <div class="row g-1">
                  <div class="col-4">
                    <input type="text" name="room" class="form-control form-control-sm" placeholder="Místnost">
                  </div>
                  <div class="col-4">
                    <input type="text" name="usage" class="form-control form-control-sm" placeholder="Využití">
                  </div>
                  <div class="col-4">
                    <input type="text" name="cable_type" class="form-control form-control-sm" placeholder="CYKY...">
                  </div>
                </div>
                <div class="row g-1 mt-1">
                  <div class="col-3">
                    <input type="text" name="cable_size" class="form-control form-control-sm" placeholder="Průřez">
                  </div>
                  <div class="col-3">
                    <input type="number" step="0.1" name="length" class="form-control form-control-sm" placeholder="Délka [m]">
                  </div>
                  <div class="col-3">
                    <input type="number" name="outlets_count" class="form-control form-control-sm" placeholder="Zásuvky/ks">
                  </div>
                  <div class="col-3">
                    <input type="text" name="note" class="form-control form-control-sm" placeholder="Pozn.">
                  </div>
                </div>
                <button type="submit" class="btn btn-sm btn-outline-primary mt-1">+ Obvod</button>
              </form>
            </td>
            <td>
              <form action="/devices/{{ dev.id }}/delete" method="post" onsubmit="return confirm('Smazat přístroj?');">
                <button type="submit" class="btn btn-sm btn-outline-danger">Smazat</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <p>Zatím žádné přístroje.</p>
{% endif %}

{% endblock %}
