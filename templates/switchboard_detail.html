{% extends "base.html" %}

{% block title %}{{ switchboard.switchboard_name or 'Rozváděč #' ~ switchboard.switchboard_id }} - Revize App{% endblock %}

{% block sidebar_breadcrumbs %}
{% set breadcrumbs = [
    {'label': 'Dashboard', 'url': '/'},
    {'label': switchboard.revision.revision_name or 'Revize #' ~ switchboard.revision.revision_id, 'url': '/revision/' ~ switchboard.revision.revision_id},
    {'label': switchboard.switchboard_name or 'Rozváděč #' ~ switchboard.switchboard_id, 'url': ''}
] %}
{{ super() }}
{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- Page Header -->
    <div class="flex items-center justify-between pb-4 border-b border-gray-200">
        <div>
            <h2 class="text-2xl font-bold text-gray-800">
                {{ switchboard.switchboard_name or 'Rozváděč #' ~ switchboard.switchboard_id }}
            </h2>
            <p class="text-sm text-gray-600 mt-1">
                Revize: <a href="/revision/{{ switchboard.revision.revision_id }}" class="text-primary hover:underline">
                    {{ switchboard.revision.revision_name or 'Revize #' ~ switchboard.revision.revision_id }}
                </a>
            </p>
        </div>
        <div class="flex items-center space-x-2">
            <a href="/switchboard/{{ switchboard.switchboard_id }}/edit" class="btn btn-primary">
                Editovat
            </a>
            <button onclick="if(confirm('Opravdu chcete smazat tento rozváděč?')) { document.getElementById('delete-form').submit(); }" 
                    class="btn btn-danger">
                Smazat
            </button>
            <a href="/revision/{{ switchboard.revision.revision_id }}" class="text-gray-600 hover:text-gray-800 p-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </a>
        </div>
    </div>

    <!-- Hidden delete form -->
    <form id="delete-form" method="POST" action="/switchboard/{{ switchboard.switchboard_id }}/delete" style="display: none;">
    </form>

    <!-- Grid layout pro info karty -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        
        <!-- Základní informace -->
        {% if switchboard.switchboard_location or switchboard.switchboard_order is not none or switchboard.switchboard_type or switchboard.switchboard_description %}
        <div class="flat-card">
            <div class="flat-card-header">Základní informace</div>
            <div class="flat-card-body">
                <table class="w-full text-sm">
                    {% if switchboard.switchboard_location %}
                    <tr>
                        <td class="py-1 text-gray-600 w-1/3">Umístění:</td>
                        <td class="py-1 font-medium">{{ switchboard.switchboard_location }}</td>
                    </tr>
                    {% endif %}
                    {% if switchboard.switchboard_order is not none %}
                    <tr>
                        <td class="py-1 text-gray-600">Pořadí:</td>
                        <td class="py-1 font-medium">{{ switchboard.switchboard_order }}</td>
                    </tr>
                    {% endif %}
                    {% if switchboard.switchboard_type %}
                    <tr>
                        <td class="py-1 text-gray-600">Typ:</td>
                        <td class="py-1 font-medium">{{ switchboard.switchboard_type }}</td>
                    </tr>
                    {% endif %}
                    {% if switchboard.switchboard_description %}
                    <tr>
                        <td class="py-1 text-gray-600 align-top">Popis:</td>
                        <td class="py-1 font-medium">{{ switchboard.switchboard_description }}</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Technické údaje -->
        {% if switchboard.switchboard_serial_number or switchboard.switchboard_production_date or switchboard.switchboard_rated_current is not none or switchboard.switchboard_rated_voltage is not none or switchboard.switchboard_ip_rating or switchboard.switchboard_impact_protection or switchboard.switchboard_protection_class %}
        <div class="flat-card">
            <div class="flat-card-header">Technické údaje</div>
            <div class="flat-card-body">
                <table class="w-full text-sm">
                    {% if switchboard.switchboard_serial_number %}
                    <tr>
                        <td class="py-1 text-gray-600 w-1/3">Sériové číslo:</td>
                        <td class="py-1 font-medium">{{ switchboard.switchboard_serial_number }}</td>
                    </tr>
                    {% endif %}
                    {% if switchboard.switchboard_production_date %}
                    <tr>
                        <td class="py-1 text-gray-600">Datum výroby:</td>
                        <td class="py-1 font-medium">{{ switchboard.switchboard_production_date.strftime('%d.%m.%Y') }}</td>
                    </tr>
                    {% endif %}
                    {% if switchboard.switchboard_rated_current is not none %}
                    <tr>
                        <td class="py-1 text-gray-600">Jmenovitý proud:</td>
                        <td class="py-1 font-medium">{{ switchboard.switchboard_rated_current }} A</td>
                    </tr>
                    {% endif %}
                    {% if switchboard.switchboard_rated_voltage is not none %}
                    <tr>
                        <td class="py-1 text-gray-600">Jmenovité napětí:</td>
                        <td class="py-1 font-medium">{{ switchboard.switchboard_rated_voltage }} V</td>
                    </tr>
                    {% endif %}
                    {% if switchboard.switchboard_ip_rating %}
                    <tr>
                        <td class="py-1 text-gray-600">Krytí IP:</td>
                        <td class="py-1 font-medium">{{ switchboard.switchboard_ip_rating }}</td>
                    </tr>
                    {% endif %}
                    {% if switchboard.switchboard_impact_protection %}
                    <tr>
                        <td class="py-1 text-gray-600">Ochrana proti nárazu:</td>
                        <td class="py-1 font-medium">{{ switchboard.switchboard_impact_protection }}</td>
                    </tr>
                    {% endif %}
                    {% if switchboard.switchboard_protection_class %}
                    <tr>
                        <td class="py-1 text-gray-600">Třída ochrany:</td>
                        <td class="py-1 font-medium">{{ switchboard.switchboard_protection_class }}</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Přístroje v rozváděči -->
    <div class="flat-card">
        <div class="flat-card-header flex items-center justify-between">
            <span>Přístroje v rozváděči</span>
            <a href="/switchboard/{{ switchboard.switchboard_id }}/device/create" 
               class="btn btn-primary text-xs">
                + Přidat přístroj
            </a>
        </div>
        <div class="flat-card-body p-0">
            {% if switchboard.devices %}
                <!-- Tabulka přístrojů -->
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 80px;">Pozice</th>
                            <th>Typ</th>
                            <th style="width: 100px;">Proud</th>
                            <th>Výrobce</th>
                            <th>Model</th>
                            <th style="width: 150px;" class="text-right">Akce</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for device in switchboard.devices %}
                            {% if not device.parent_device_id %}
                            <!-- Root device -->
                            <tr>
                                <td>
                                    <span class="font-mono text-xs bg-gray-100 px-2 py-1 border border-gray-300">
                                        {{ device.switchboard_device_position }}
                                    </span>
                                </td>
                                <td class="font-medium">{{ device.switchboard_device_type or 'N/A' }}</td>
                                <td>
                                    {% if device.switchboard_device_rated_current %}
                                        {{ device.switchboard_device_rated_current }}A
                                    {% endif %}
                                </td>
                                <td class="text-gray-600">{{ device.switchboard_device_manufacturer or '—' }}</td>
                                <td class="text-gray-600">{{ device.switchboard_device_model or '—' }}</td>
                                <td class="text-right">
                                    <div class="flex justify-end items-center gap-1">
                                        <a href="/device/{{ device.device_id }}" class="action-icon action-icon-view" title="Detail">
                                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                            </svg>
                                        </a>
                                        <a href="/device/{{ device.device_id }}/edit" class="action-icon action-icon-edit" title="Editovat">
                                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </a>
                                        <button onclick="document.getElementById('duplicate-device-{{ device.device_id }}').submit();" 
                                                class="action-icon action-icon-edit" title="Duplikovat">
                                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                            </svg>
                                        </button>
                                        <form id="duplicate-device-{{ device.device_id }}" method="POST" action="/device/{{ device.device_id }}/duplicate" style="display: none;"></form>
                                        <button onclick="if(confirm('Opravdu chcete smazat tento přístroj{% if device.child_devices %} a všechny podřízené přístroje{% endif %}?')) { document.getElementById('delete-device-{{ device.device_id }}').submit(); }" 
                                                class="action-icon action-icon-delete" title="Smazat">
                                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                        <form id="delete-device-{{ device.device_id }}" method="POST" action="/device/{{ device.device_id }}/delete" style="display: none;"></form>
                                    </div>
                                </td>
                            </tr>
                            
                            <!-- Child devices -->
                            {% if device.child_devices %}
                                {% for child in device.child_devices %}
                                <tr style="background-color: #fafbfc;">
                                    <td>
                                        <div class="flex items-center gap-1">
                                            <span class="text-gray-400">└─</span>
                                            <span class="font-mono text-xs bg-white px-2 py-1 border border-gray-300">
                                                {{ child.switchboard_device_position }}
                                            </span>
                                        </div>
                                    </td>
                                    <td class="font-medium">{{ child.switchboard_device_type or 'N/A' }}</td>
                                    <td>
                                        {% if child.switchboard_device_rated_current %}
                                            {{ child.switchboard_device_rated_current }}A
                                        {% endif %}
                                    </td>
                                    <td class="text-gray-600">{{ child.switchboard_device_manufacturer or '—' }}</td>
                                    <td class="text-gray-600">{{ child.switchboard_device_model or '—' }}</td>
                                    <td class="text-right">
                                        <div class="flex justify-end items-center gap-1">
                                            <a href="/device/{{ child.device_id }}" class="action-icon action-icon-view" title="Detail">
                                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                </svg>
                                            </a>
                                            <a href="/device/{{ child.device_id }}/edit" class="action-icon action-icon-edit" title="Editovat">
                                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                </svg>
                                            </a>
                                            <button onclick="document.getElementById('duplicate-device-{{ child.device_id }}').submit();" 
                                                    class="action-icon action-icon-edit" title="Duplikovat">
                                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                                </svg>
                                            </button>
                                            <form id="duplicate-device-{{ child.device_id }}" method="POST" action="/device/{{ child.device_id }}/duplicate" style="display: none;"></form>
                                            <button onclick="if(confirm('Opravdu chcete smazat tento přístroj?')) { document.getElementById('delete-device-{{ child.device_id }}').submit(); }" 
                                                    class="action-icon action-icon-delete" title="Smazat">
                                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                </svg>
                                            </button>
                                            <form id="delete-device-{{ child.device_id }}" method="POST" action="/device/{{ child.device_id }}/delete" style="display: none;"></form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% endif %}
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="p-8 text-center text-gray-500">
                    Žádné přístroje. <a href="/switchboard/{{ switchboard.switchboard_id }}/device/create" class="text-primary hover:underline">Přidat první přístroj</a>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
