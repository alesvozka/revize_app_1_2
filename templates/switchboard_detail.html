{% extends "base.html" %}
{% block title %}Rozvaděč – detail{% endblock %}
{% block content %}
<a href="/revisions/{{ revision.revision_id }}" class="btn btn-link mb-2">&larr; Zpět na revizi</a>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h4 mb-0">{{ switchboard.switchboard_name or "Rozvaděč" }}</h1>
    <div class="text-muted small">
      {% if switchboard.switchboard_location %}
        <span class="me-2">Místo: {{ switchboard.switchboard_location }}</span>
      {% endif %}
      {% if switchboard.switchboard_type %}
        <span class="me-2">Typ: {{ switchboard.switchboard_type }}</span>
      {% endif %}
      {% if switchboard.switchboard_serial_number %}
        <span class="me-2">Výrobní číslo: {{ switchboard.switchboard_serial_number }}</span>
      {% endif %}
      {% if switchboard.switchboard_ip_rating %}
        <span class="me-2">IP: {{ switchboard.switchboard_ip_rating }}</span>
      {% endif %}
    </div>
  </div>
  <form action="/switchboards/{{ switchboard.switchboard_id }}/delete" method="post"
        onsubmit="return confirm('Opravdu smazat rozvaděč?');">
    <button type="submit" class="btn btn-outline-danger btn-sm">Smazat</button>
  </form>
</div>

<div class="row">
  <div class="col-12">
    <!-- Údaje o rozvaděči -->
    <div class="card mb-3">
      <div class="card-header">
        Údaje o rozvaděči
      </div>
      <div class="card-body">
        <form action="/switchboards/{{ switchboard.switchboard_id }}/edit" method="post" class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Název</label>
            <input type="text" name="switchboard_name" class="form-control" value="{{ switchboard.switchboard_name or '' }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">Umístění</label>
            <input type="text" name="switchboard_location" class="form-control" value="{{ switchboard.switchboard_location or '' }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">Poznámka</label>
            <input type="text" name="switchboard_note" class="form-control" value="{{ switchboard.switchboard_note or '' }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">Typ rozvaděče</label>
            <input type="text" name="switchboard_type" class="form-control" value="{{ switchboard.switchboard_type or '' }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">Výrobní číslo</label>
            <input type="text" name="switchboard_serial_number" class="form-control" value="{{ switchboard.switchboard_serial_number or '' }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">IP krytí</label>
            <input type="text" name="switchboard_ip_rating" class="form-control" value="{{ switchboard.switchboard_ip_rating or '' }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">Výrobce</label>
            <input type="text" name="switchboard_manufacturer" class="form-control" value="{{ switchboard.switchboard_manufacturer or '' }}">
          </div>
          <div class="col-12 mt-2">
            <button type="submit" class="btn btn-primary btn-sm">Uložit údaje rozvaděče</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Měření rozvaděče -->
    <div class="card mb-3">
      <div class="card-header">
        Měření rozvaděče
      </div>
      <div class="card-body">
        <form action="/switchboards/{{ switchboard.switchboard_id }}/measurements/edit" method="post" class="row g-2">
          <div class="col-md-3">
            <label class="form-label">Zs min [Ω]</label>
            <input type="number" step="0.01" name="measurements_switchboard_zs_min"
                   class="form-control"
                   value="{{ measurement.measurements_switchboard_zs_min if measurement else '' }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">Zs max [Ω]</label>
            <input type="number" step="0.01" name="measurements_switchboard_zs_max"
                   class="form-control"
                   value="{{ measurement.measurements_switchboard_zs_max if measurement else '' }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">tΔ [ms]</label>
            <input type="number" step="0.1" name="measurements_switchboard_rcd_trip_time_ms"
                   class="form-control"
                   value="{{ measurement.measurements_switchboard_rcd_trip_time_ms if measurement else '' }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">IΔ [mA]</label>
            <input type="number" step="0.1" name="measurements_switchboard_rcd_test_current_ma"
                   class="form-control"
                   value="{{ measurement.measurements_switchboard_rcd_test_current_ma if measurement else '' }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">Rz [Ω]</label>
            <input type="number" step="0.1" name="measurements_switchboard_earth_resistance"
                   class="form-control"
                   value="{{ measurement.measurements_switchboard_earth_resistance if measurement else '' }}">
          </div>
          <div class="col-12 mt-2">
            <button type="submit" class="btn btn-primary btn-sm">Uložit měření rozvaděče</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Proudové chrániče -->
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Proudové chrániče (RCD)</span>
        <button type="button" class="btn btn-sm btn-outline-primary" id="btn-add-rcd">Přidat chránič</button>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm table-hover mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th>Pozice</th>
                <th>Popis</th>
                <th>Parametry</th>
                <th class="text-nowrap">Akce</th>
              </tr>
            </thead>
            <tbody>
              {% for dev in devices %}
                {% if dev.switchboard_device_residual_current_ma is not none
                      or (dev.switchboard_device_type and 'RCD' in dev.switchboard_device_type) %}
                  <tr class="device-row"
                      data-device-id="{{ dev.device_id }}"
                      data-parent-id="{{ dev.parent_device_id or '' }}"
                      data-device-position="{{ dev.switchboard_device_position or '' }}"
                      data-device-type="{{ dev.switchboard_device_type or '' }}"
                      data-device-manufacturer="{{ dev.switchboard_device_manufacturer or '' }}"
                      data-device-model="{{ dev.switchboard_device_model or '' }}"
                      data-device-trip="{{ dev.switchboard_device_trip_characteristic or '' }}"
                      data-device-rated-current="{{ dev.switchboard_device_rated_current or '' }}"
                      data-device-residual-current="{{ dev.switchboard_device_residual_current_ma or '' }}"
                      data-device-poles="{{ dev.switchboard_device_poles or '' }}"
                      data-device-module-width="{{ dev.switchboard_device_module_width or '' }}">
                    <td><strong>{{ dev.switchboard_device_position or '-' }}</strong></td>
                    <td>
                      {% if dev.switchboard_device_manufacturer or dev.switchboard_device_model %}
                        <div>{{ dev.switchboard_device_manufacturer }} {{ dev.switchboard_device_model }}</div>
                      {% endif %}
                    </td>
                    <td class="small">
                      In: {{ dev.switchboard_device_rated_current or "-" }} A<br>
                      IΔn: {{ dev.switchboard_device_residual_current_ma or "-" }} mA<br>
                      Póly: {{ dev.switchboard_device_poles or "-" }}
                    </td>
                    <td class="text-nowrap">
                      <button type="button"
                              class="btn btn-sm btn-outline-success me-1 btn-device-add-child"
                              title="Přidat podřízený přístroj">+</button>
                      <button type="button"
                              class="btn btn-sm btn-outline-primary me-1 btn-device-edit">
                        Upravit
                      </button>
                      <form action="/devices/{{ dev.device_id }}/delete" method="post" class="d-inline"
                            onsubmit="return confirm('Smazat tento chránič?');">
                        <button type="submit" class="btn btn-sm btn-outline-danger">Smazat</button>
                      </form>
                    </td>
                  </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Jističe a ostatní přístroje -->
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Jističe a ostatní přístroje</span>
        <button type="button" class="btn btn-sm btn-outline-primary" id="btn-add-device">Přidat přístroj</button>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm table-hover mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th>Pozice</th>
                <th>Popis</th>
                <th>Parametry</th>
                <th>Obvody</th>
                <th>RCD</th>
                <th class="text-nowrap">Akce</th>
              </tr>
            </thead>
            <tbody>
              {% for dev in devices %}
                {% set is_rcd = dev.switchboard_device_residual_current_ma is not none
                                or (dev.switchboard_device_type and 'RCD' in dev.switchboard_device_type) %}
                {% if not is_rcd %}
                  <tr class="device-row"
                      data-device-id="{{ dev.device_id }}"
                      data-parent-id="{{ dev.parent_device_id or '' }}"
                      data-device-position="{{ dev.switchboard_device_position or '' }}"
                      data-device-type="{{ dev.switchboard_device_type or '' }}"
                      data-device-manufacturer="{{ dev.switchboard_device_manufacturer or '' }}"
                      data-device-model="{{ dev.switchboard_device_model or '' }}"
                      data-device-trip="{{ dev.switchboard_device_trip_characteristic or '' }}"
                      data-device-rated-current="{{ dev.switchboard_device_rated_current or '' }}"
                      data-device-residual-current="{{ dev.switchboard_device_residual_current_ma or '' }}"
                      data-device-poles="{{ dev.switchboard_device_poles or '' }}"
                      data-device-module-width="{{ dev.switchboard_device_module_width or '' }}">
                    <td><strong>{{ dev.switchboard_device_position or '-' }}</strong></td>
                    <td>
                      <div>{{ dev.switchboard_device_type or '' }}</div>
                      {% if dev.switchboard_device_manufacturer or dev.switchboard_device_model %}
                        <div class="small text-muted">{{ dev.switchboard_device_manufacturer }} {{ dev.switchboard_device_model }}</div>
                      {% endif %}
                    </td>
                    <td class="small">
                      {% if dev.switchboard_device_trip_characteristic %}
                        Char.: {{ dev.switchboard_device_trip_characteristic }}<br>
                      {% endif %}
                      In: {{ dev.switchboard_device_rated_current or "-" }} A<br>
                      {% if dev.switchboard_device_residual_current_ma %}
                        IΔn: {{ dev.switchboard_device_residual_current_ma }} mA<br>
                      {% endif %}
                      Póly: {{ dev.switchboard_device_poles or "-" }} / Moduly: {{ dev.switchboard_device_module_width or "-" }}
                    </td>
                    <td>
                      {% set has_circuits = false %}
                      {% for circ in circuits if circ.device_id == dev.device_id %}
                        {% set has_circuits = true %}
                        <div class="small">
                          <a href="/circuits/{{ circ.circuit_id }}">
                            Obvod {{ circ.circuit_number or "-" }}
                          </a>
                          {% if circ.circuit_room %}
                            <span class="text-muted"> – {{ circ.circuit_room }}</span>
                          {% endif %}
                        </div>
                      {% endfor %}
                      {% if not has_circuits %}
                        <span class="text-muted small">Žádný obvod</span>
                      {% endif %}
                    </td>
                    <td>
                      <form action="/devices/{{ dev.device_id }}/set-parent" method="post" class="mb-0">
                        <select name="parent_device_id" class="form-select form-select-sm" onchange="this.form.submit()">
                          <option value="">(bez RCD)</option>
                          {% for rcd in devices %}
                            {% if rcd.switchboard_device_residual_current_ma is not none
                                  or (rcd.switchboard_device_type and 'RCD' in rcd.switchboard_device_type) %}
                              <option value="{{ rcd.device_id }}"
                                      {% if dev.parent_device_id == rcd.device_id %}selected{% endif %}>
                                {{ rcd.switchboard_device_position or 'RCD' }}
                              </option>
                            {% endif %}
                          {% endfor %}
                        </select>
                      </form>
                    </td>
                    <td class="text-nowrap">
                      <button type="button"
                              class="btn btn-sm btn-outline-success me-1 btn-device-add-child"
                              title="Přidat podřízený přístroj">+</button>
                      <button type="button"
                              class="btn btn-sm btn-outline-primary me-1 btn-device-edit">
                        Upravit
                      </button>
                      <form action="/devices/{{ dev.device_id }}/delete" method="post" class="d-inline"
                            onsubmit="return confirm('Smazat tento přístroj?');">
                        <button type="submit" class="btn btn-sm btn-outline-danger">Smazat</button>
                      </form>
                    </td>
                  </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Offcanvas drawer pro přístroj -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="deviceDrawer" aria-labelledby="deviceDrawerLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="deviceDrawerLabel">Přidat / upravit přístroj</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Zavřít"></button>
  </div>
  <div class="offcanvas-body">
    <form id="device-form" action="/switchboards/{{ switchboard.switchboard_id }}/devices/create" method="post" class="row g-2">
      <input type="hidden" name="device_id" id="device-id-field">
      <input type="hidden" name="parent_device_id" id="parent-device-id-field">
      <div class="col-4">
        <label class="form-label form-label-sm">Pozice</label>
        <input type="text" name="switchboard_device_position" class="form-control form-control-sm">
      </div>
      <div class="col-8">
        <label class="form-label form-label-sm">Typ</label>
        <input type="text" name="switchboard_device_type" class="form-control form-control-sm">
      </div>
      <div class="col-6">
        <label class="form-label form-label-sm">Výrobce</label>
        <input type="text" name="switchboard_device_manufacturer" class="form-control form-control-sm">
      </div>
      <div class="col-6">
        <label class="form-label form-label-sm">Model</label>
        <input type="text" name="switchboard_device_model" class="form-control form-control-sm">
      </div>
      <div class="col-4">
        <label class="form-label form-label-sm">Charakter.</label>
        <input type="text" name="switchboard_device_trip_characteristic" class="form-control form-control-sm">
      </div>
      <div class="col-4">
        <label class="form-label form-label-sm">In [A]</label>
        <input type="number" step="0.1" name="switchboard_device_rated_current" class="form-control form-control-sm">
      </div>
      <div class="col-4">
        <label class="form-label form-label-sm">IΔn [mA]</label>
        <input type="number" step="0.1" name="switchboard_device_residual_current_ma" class="form-control form-control-sm">
      </div>
      <div class="col-6">
        <label class="form-label form-label-sm">Póly</label>
        <input type="number" step="1" name="switchboard_device_poles" class="form-control form-control-sm">
      </div>
      <div class="col-6">
        <label class="form-label form-label-sm">Moduly</label>
        <input type="number" step="0.5" name="switchboard_device_module_width" class="form-control form-control-sm">
      </div>
      <div class="col-12 mt-2">
        <button type="submit" class="btn btn-primary btn-sm w-100">Uložit přístroj</button>
      </div>
      <div class="col-12">
        <small class="text-muted">Kliknutím na přístroj v seznamu se formulář automaticky vyplní.</small>
      </div>
    </form>
  </div>
</div>

<style>
  @media (min-width: 768px) {
    #deviceDrawer.offcanvas-end {
      width: 40vw;
      max-width: 640px;
    }
  }
</style>

<script>
(function() {
  if (typeof window === 'undefined') return;

  function getDrawer() {
    const el = document.getElementById('deviceDrawer');
    if (!el) return null;
    if (window.bootstrap && bootstrap.Offcanvas) {
      return bootstrap.Offcanvas.getOrCreateInstance(el);
    }
    return null;
  }

  function clearDeviceForm() {
    const form = document.getElementById('device-form');
    if (!form) return;
    form.reset();
    const idField = document.getElementById('device-id-field');
    const parentField = document.getElementById('parent-device-id-field');
    if (idField) idField.value = '';
    if (parentField) parentField.value = '';
    const title = document.getElementById('deviceDrawerLabel');
    if (title) title.textContent = 'Přidat přístroj';
  }

  function fillDeviceFormFromRow(row) {
    const form = document.getElementById('device-form');
    if (!form) return;
    const idField = document.getElementById('device-id-field');
    const parentField = document.getElementById('parent-device-id-field');
    if (idField) idField.value = row.getAttribute('data-device-id') || '';
    if (parentField) parentField.value = row.getAttribute('data-parent-id') || '';

    const setField = (name, value) => {
      const input = form.querySelector('[name="' + name + '"]');
      if (input) input.value = value || '';
    };

    setField('switchboard_device_position', row.getAttribute('data-device-position'));
    setField('switchboard_device_type', row.getAttribute('data-device-type'));
    setField('switchboard_device_manufacturer', row.getAttribute('data-device-manufacturer'));
    setField('switchboard_device_model', row.getAttribute('data-device-model'));
    setField('switchboard_device_trip_characteristic', row.getAttribute('data-device-trip'));
    setField('switchboard_device_rated_current', row.getAttribute('data-device-rated-current'));
    setField('switchboard_device_residual_current_ma', row.getAttribute('data-device-residual-current'));
    setField('switchboard_device_poles', row.getAttribute('data-device-poles'));
    setField('switchboard_device_module_width', row.getAttribute('data-device-module-width'));

    const title = document.getElementById('deviceDrawerLabel');
    if (title) {
      const pos = row.getAttribute('data-device-position') || '';
      title.textContent = pos ? ('Upravit přístroj ' + pos) : 'Upravit přístroj';
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    const rows = document.querySelectorAll('.device-row');
    rows.forEach(row => {
      row.addEventListener('click', function(e) {
        if (e.target.closest('button') || e.target.closest('form') || e.target.tagName === 'SELECT') {
          return;
        }
        clearDeviceForm();
        fillDeviceFormFromRow(row);
        const drawer = getDrawer();
        if (drawer) drawer.show();
      });
    });

    const editButtons = document.querySelectorAll('.btn-device-edit');
    editButtons.forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        const row = btn.closest('tr');
        if (row) {
          clearDeviceForm();
          fillDeviceFormFromRow(row);
          const drawer = getDrawer();
          if (drawer) drawer.show();
        }
      });
    });

    const childButtons = document.querySelectorAll('.btn-device-add-child');
    childButtons.forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        const row = btn.closest('tr');
        if (!row) return;
        clearDeviceForm();
        const form = document.getElementById('device-form');
        if (!form) return;
        const parentField = document.getElementById('parent-device-id-field');
        if (parentField) {
          parentField.value = row.getAttribute('data-device-id') || '';
        }
        const posField = form.querySelector('[name="switchboard_device_position"]');
        if (posField) {
          const base = row.getAttribute('data-device-position') || '';
          posField.value = base ? (base + '.') : '';
        }
        const drawer = getDrawer();
        if (drawer) drawer.show();
      });
    });

    const btnAddDevice = document.getElementById('btn-add-device');
    if (btnAddDevice) {
      btnAddDevice.addEventListener('click', function(e) {
        e.preventDefault();
        clearDeviceForm();
        const drawer = getDrawer();
        if (drawer) drawer.show();
      });
    }

    const btnAddRcd = document.getElementById('btn-add-rcd');
    if (btnAddRcd) {
      btnAddRcd.addEventListener('click', function(e) {
        e.preventDefault();
        clearDeviceForm();
        const form = document.getElementById('device-form');
        if (!form) return;
        const typeField = form.querySelector('[name="switchboard_device_type"]');
        const polesField = form.querySelector('[name="switchboard_device_poles"]');
        if (typeField) typeField.value = 'RCD';
        if (polesField) polesField.value = '4';
        const drawer = getDrawer();
        if (drawer) drawer.show();
      });
    }
  });
})();
</script>

{% endblock %}
