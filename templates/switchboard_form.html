{% extends "base.html" %}
{% from "components/form_field.html" import render_field %}

{% block title %}{% if switchboard %}Editace rozváděče{% else %}Nový rozváděč{% endif %} - Revize App{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Page Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">
                    {% if is_duplicate %}Duplikace rozváděče{% elif switchboard %}Editace rozváděče{% else %}Nový rozváděč{% endif %}
                </h2>
                <p class="text-gray-600 mt-1">
                    Revize: {{ revision.revision_name or 'Revize #' ~ revision.revision_id }}
                </p>
            </div>
            <a href="/revision/{{ revision.revision_id }}" class="text-gray-600 hover:text-gray-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </a>
        </div>
    </div>

    <!-- Form -->
    <form method="POST" action="{% if is_duplicate %}/switchboard/{{ switchboard.switchboard_id }}/duplicate{% elif switchboard %}/switchboard/{{ switchboard.switchboard_id }}/update{% else %}/revision/{{ revision.revision_id }}/switchboard/create{% endif %}" class="bg-white rounded-lg shadow p-6">
        
        <!-- Základní informace -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 pb-2 border-b">Základní informace</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Název rozváděče *</label>
                    <input type="text" name="switchboard_name" value="{% if switchboard %}{{ switchboard.switchboard_name or '' }}{% endif %}" 
                           required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Umístění</label>
                    <input type="text" name="switchboard_location" value="{% if switchboard %}{{ switchboard.switchboard_location or '' }}{% endif %}" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Pořadí</label>
                    <input type="number" name="switchboard_order" value="{% if switchboard and switchboard.switchboard_order is not none %}{{ switchboard.switchboard_order }}{% endif %}" 
                           min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                {{ render_field(
                    'switchboard_type',
                    'Typ rozváděče',
                    current_value=(switchboard.switchboard_type if switchboard else ''),
                    entity_type='switchboard',
                    dropdown_config=dropdown_config,
                    dropdown_sources=dropdown_sources
                ) }}
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Popis</label>
                    <textarea name="switchboard_description" rows="2" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">{% if switchboard %}{{ switchboard.switchboard_description or '' }}{% endif %}</textarea>
                </div>
            </div>
        </div>

        <!-- Technické údaje -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 pb-2 border-b">Technické údaje</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Sériové číslo</label>
                    <input type="text" name="switchboard_serial_number" value="{% if switchboard %}{{ switchboard.switchboard_serial_number or '' }}{% endif %}" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Datum výroby</label>
                    <input type="date" name="switchboard_production_date" value="{% if switchboard and switchboard.switchboard_production_date %}{{ switchboard.switchboard_production_date.strftime('%Y-%m-%d') }}{% endif %}" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jmenovitý proud (A)</label>
                    <input type="number" step="0.01" name="switchboard_rated_current" value="{% if switchboard and switchboard.switchboard_rated_current is not none %}{{ switchboard.switchboard_rated_current }}{% endif %}" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jmenovité napětí (V)</label>
                    <input type="number" step="0.01" name="switchboard_rated_voltage" value="{% if switchboard and switchboard.switchboard_rated_voltage is not none %}{{ switchboard.switchboard_rated_voltage }}{% endif %}" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                {{ render_field(
                    'switchboard_ip_rating',
                    'Krytí IP',
                    current_value=(switchboard.switchboard_ip_rating if switchboard else ''),
                    entity_type='switchboard',
                    dropdown_config=dropdown_config,
                    dropdown_sources=dropdown_sources,
                    placeholder='např. IP44'
                ) }}
                
                {{ render_field(
                    'switchboard_impact_protection',
                    'Ochrana proti nárazu',
                    current_value=(switchboard.switchboard_impact_protection if switchboard else ''),
                    entity_type='switchboard',
                    dropdown_config=dropdown_config,
                    dropdown_sources=dropdown_sources,
                    placeholder='např. IK08'
                ) }}
                
                {{ render_field(
                    'switchboard_protection_class',
                    'Třída ochrany',
                    current_value=(switchboard.switchboard_protection_class if switchboard else ''),
                    entity_type='switchboard',
                    dropdown_config=dropdown_config,
                    dropdown_sources=dropdown_sources,
                    placeholder='např. I, II'
                ) }}
            </div>
        </div>

        <!-- Výrobce -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 pb-2 border-b">Výrobce</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {{ render_field(
                    'switchboard_manufacturer',
                    'Výrobce rozváděče',
                    current_value=(switchboard.switchboard_manufacturer if switchboard else ''),
                    entity_type='switchboard',
                    dropdown_config=dropdown_config,
                    dropdown_sources=dropdown_sources
                ) }}
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Adresa výrobce</label>
                    <input type="text" name="switchboard_manufacturer_address" value="{% if switchboard %}{{ switchboard.switchboard_manufacturer_address or '' }}{% endif %}" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Normy</label>
                    <textarea name="switchboard_standards" rows="2" 
                              placeholder="např. ČSN EN 61439-1, ČSN EN 61439-2"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">{% if switchboard %}{{ switchboard.switchboard_standards or '' }}{% endif %}</textarea>
                </div>
            </div>
        </div>

        <!-- Skříň rozváděče -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 pb-2 border-b">Skříň rozváděče</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Typ skříně</label>
                    <input type="text" name="switchboard_enclosure_type" value="{% if switchboard %}{{ switchboard.switchboard_enclosure_type or '' }}{% endif %}" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                {{ render_field(
                    'switchboard_enclosure_manufacturer',
                    'Výrobce skříně',
                    current_value=(switchboard.switchboard_enclosure_manufacturer if switchboard else ''),
                    entity_type='switchboard',
                    dropdown_config=dropdown_config,
                    dropdown_sources=dropdown_sources
                ) }}
                
                <div class="md:col-span-2">
                    {{ render_field(
                        'switchboard_enclosure_installation_method',
                        'Způsob instalace skříně',
                        current_value=(switchboard.switchboard_enclosure_installation_method if switchboard else ''),
                        entity_type='switchboard',
                        dropdown_config=dropdown_config,
                        dropdown_sources=dropdown_sources,
                        placeholder='např. nástěnná, vestavěná'
                    ) }}
                </div>
            </div>
        </div>

        <!-- Nadřazený rozváděč -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 pb-2 border-b">Nadřazený rozváděč</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nadřazený rozváděč</label>
                    <input type="text" name="switchboard_superior_switchboard" value="{% if switchboard %}{{ switchboard.switchboard_superior_switchboard or '' }}{% endif %}" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jistič - jmenovitý proud (A)</label>
                    <input type="number" step="0.01" name="switchboard_superior_circuit_breaker_rated_current" value="{% if switchboard and switchboard.switchboard_superior_circuit_breaker_rated_current is not none %}{{ switchboard.switchboard_superior_circuit_breaker_rated_current }}{% endif %}" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                {{ render_field(
                    'switchboard_superior_circuit_breaker_trip_characteristic',
                    'Jistič - charakteristika',
                    current_value=(switchboard.switchboard_superior_circuit_breaker_trip_characteristic if switchboard else ''),
                    entity_type='switchboard',
                    dropdown_config=dropdown_config,
                    dropdown_sources=dropdown_sources,
                    placeholder='např. B, C, D'
                ) }}
                
                {{ render_field(
                    'switchboard_superior_circuit_breaker_manufacturer',
                    'Jistič - výrobce',
                    current_value=(switchboard.switchboard_superior_circuit_breaker_manufacturer if switchboard else ''),
                    entity_type='switchboard',
                    dropdown_config=dropdown_config,
                    dropdown_sources=dropdown_sources
                ) }}
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jistič - model</label>
                    <input type="text" name="switchboard_superior_circuit_breaker_model" value="{% if switchboard %}{{ switchboard.switchboard_superior_circuit_breaker_model or '' }}{% endif %}" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
            </div>
        </div>

        <!-- Hlavní vypínač a kabel -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 pb-2 border-b">Hlavní vypínač a kabel</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Hlavní vypínač</label>
                    <input type="text" name="switchboard_main_switch" value="{% if switchboard %}{{ switchboard.switchboard_main_switch or '' }}{% endif %}" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                {{ render_field(
                    'switchboard_cable',
                    'Kabel',
                    current_value=(switchboard.switchboard_cable if switchboard else ''),
                    entity_type='switchboard',
                    dropdown_config=dropdown_config,
                    dropdown_sources=dropdown_sources,
                    placeholder='např. CYKY 5x10'
                ) }}
                
                <div class="md:col-span-2">
                    {{ render_field(
                        'switchboard_cable_installation_method',
                        'Způsob instalace kabelu',
                        current_value=(switchboard.switchboard_cable_installation_method if switchboard else ''),
                        entity_type='switchboard',
                        dropdown_config=dropdown_config,
                        dropdown_sources=dropdown_sources,
                        placeholder='např. v zemi, na zdi, v lištách'
                    ) }}
                </div>
            </div>
        </div>

        <!-- Poznámka -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 pb-2 border-b">Poznámka</h3>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Poznámka</label>
                <textarea name="switchboard_note" rows="3" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">{% if switchboard %}{{ switchboard.switchboard_note or '' }}{% endif %}</textarea>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="flex items-center justify-between pt-6 border-t">
            <a href="/revision/{{ revision.revision_id }}" class="px-4 py-2 text-gray-700 hover:text-gray-900 transition">
                Zrušit
            </a>
            <button type="submit" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                {% if switchboard %}Uložit změny{% else %}Vytvořit rozváděč{% endif %}
            </button>
        </div>
    </form>
</div>

<script>
// Switch between dropdown modes
function switchDropdownMode(fieldName, mode) {
    const container = document.querySelector(`.dropdown-widget-container[data-field="${fieldName}"]`);
    
    // Hide all mode contents
    container.querySelectorAll('.mode-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Remove active state from all buttons
    container.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
        btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
    });
    
    // Show selected mode content
    const selectedContent = container.querySelector(`.mode-${mode}[data-field="${fieldName}"]`);
    selectedContent.classList.remove('hidden');
    
    // Add active state to selected button
    const selectedBtn = container.querySelector(`.mode-btn-${mode}[data-field="${fieldName}"]`);
    selectedBtn.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
    selectedBtn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
    
    // Disable/enable form fields based on mode
    const selectField = container.querySelector(`select#${fieldName}`);
    const textField = container.querySelector(`input#${fieldName}_text`);
    
    if (mode === 'select') {
        selectField.disabled = false;
        if (textField) textField.disabled = true;
    } else if (mode === 'text') {
        selectField.disabled = true;
        if (textField) textField.disabled = false;
    } else {
        selectField.disabled = true;
        if (textField) textField.disabled = true;
    }
}

// Add new value to dropdown and select it
async function addNewDropdownValue(fieldName, category) {
    const container = document.querySelector(`.dropdown-widget-container[data-field="${fieldName}"]`);
    const newValueInput = container.querySelector(`#${fieldName}_new`);
    const value = newValueInput.value.trim();
    
    if (!value) {
        alert('Zadejte hodnotu');
        return;
    }
    
    try {
        // Send request to add new value
        const formData = new FormData();
        formData.append('value', value);
        
        const response = await fetch(`/api/dropdown/${category}/add`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Add new option to select
            const selectField = container.querySelector(`select#${fieldName}`);
            const newOption = document.createElement('option');
            newOption.value = data.value;
            newOption.text = data.value;
            newOption.selected = true;
            selectField.appendChild(newOption);
            
            // Switch back to select mode
            switchDropdownMode(fieldName, 'select');
            
            // Clear input
            newValueInput.value = '';
            
            // Show success message
            alert(`Hodnota "${data.value}" byla přidána a vybrána`);
        } else {
            alert('Chyba při přidávání hodnoty: ' + (data.error || 'Neznámá chyba'));
        }
    } catch (error) {
        console.error('Error adding dropdown value:', error);
        alert('Chyba při přidávání hodnoty');
    }
}

// Initialize dropdown widgets on page load
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.dropdown-widget-container').forEach(container => {
        const fieldName = container.getAttribute('data-field');
        // Start with select mode by default
        switchDropdownMode(fieldName, 'select');
    });
});
</script>

<style>
.dropdown-widget-container {
    position: relative;
}

.mode-btn {
    cursor: pointer;
}

.mode-btn:hover {
    opacity: 0.8;
}
</style>
{% endblock %}
